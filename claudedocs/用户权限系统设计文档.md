# 用户权限系统设计文档

## 1. 系统概述

### 1.1 需求分析
- 账号密码登录认证
- 用户注册功能
- 默认管理员账户
- 基于角色的权限控制 (RBAC)
- 三种预设角色：管理员、标注员、普通用户
- 支持自定义权限配置

### 1.2 技术栈
- **后端**: FastAPI + Motor (异步 MongoDB)
- **数据库**: MongoDB
- **认证**: JWT (JSON Web Token)
- **密码加密**: bcrypt
- **前端**: React + TypeScript

---

## 2. 数据库设计

### 2.1 Users 集合 (用户表)

```javascript
{
  "_id": ObjectId,                    // MongoDB 自动生成
  "username": String,                 // 用户名，唯一
  "email": String,                    // 邮箱，唯一，可选
  "password_hash": String,            // bcrypt 加密后的密码
  "role_id": ObjectId,                // 关联到 roles 集合
  "is_active": Boolean,               // 账户是否激活
  "is_deleted": Boolean,              // 软删除标记
  "created_at": ISODate,              // 创建时间
  "updated_at": ISODate,              // 更新时间
  "last_login_at": ISODate,           // 最后登录时间
  "metadata": {                       // 扩展信息
    "full_name": String,              // 真实姓名
    "phone": String,                  // 联系电话
    "department": String              // 部门
  }
}
```

**索引设计**:
```javascript
db.users.createIndex({ "username": 1 }, { unique: true })
db.users.createIndex({ "email": 1 }, { unique: true, sparse: true })
db.users.createIndex({ "role_id": 1 })
db.users.createIndex({ "is_active": 1, "is_deleted": 1 })
```

### 2.2 Roles 集合 (角色表)

```javascript
{
  "_id": ObjectId,
  "name": String,                     // 角色名称，唯一
  "display_name": String,             // 角色显示名称
  "description": String,              // 角色描述
  "permissions": [String],            // 权限列表
  "is_system": Boolean,               // 是否系统预设角色（不可删除）
  "is_active": Boolean,               // 是否启用
  "created_at": ISODate,
  "updated_at": ISODate
}
```

**索引设计**:
```javascript
db.roles.createIndex({ "name": 1 }, { unique: true })
db.roles.createIndex({ "is_system": 1 })
```

### 2.3 预设角色和权限

#### 权限定义

```python
# 权限分类
PERMISSIONS = {
    # 用户管理
    "users.view": "查看用户列表",
    "users.create": "创建用户",
    "users.update": "更新用户信息",
    "users.delete": "删除用户",

    # 文件管理
    "files.view": "查看文件列表",
    "files.upload": "上传文件",
    "files.delete": "删除文件",

    # 标注管理
    "annotations.view": "查看标注",
    "annotations.create": "创建标注",
    "annotations.update": "更新标注",
    "annotations.delete": "删除标注",
    "annotations.export": "导出标注",

    # 模板管理
    "templates.view": "查看模板",
    "templates.create": "创建模板",
    "templates.update": "更新模板",
    "templates.delete": "删除模板",

    # 角色管理
    "roles.view": "查看角色",
    "roles.create": "创建角色",
    "roles.update": "更新角色",
    "roles.delete": "删除角色",

    # 系统管理
    "system.settings": "系统设置",
    "system.logs": "查看系统日志"
}
```

#### 预设角色配置

```javascript
// 1. 管理员角色
{
  "name": "admin",
  "display_name": "管理员",
  "description": "系统管理员，拥有所有权限",
  "permissions": [
    "users.view", "users.create", "users.update", "users.delete",
    "files.view", "files.upload", "files.delete",
    "annotations.view", "annotations.create", "annotations.update",
    "annotations.delete", "annotations.export",
    "templates.view", "templates.create", "templates.update", "templates.delete",
    "roles.view", "roles.create", "roles.update", "roles.delete",
    "system.settings", "system.logs"
  ],
  "is_system": true,
  "is_active": true
}

// 2. 标注员角色
{
  "name": "annotator",
  "display_name": "标注员",
  "description": "负责数据标注的用户",
  "permissions": [
    "files.view",
    "annotations.view", "annotations.create", "annotations.update",
    "templates.view"
  ],
  "is_system": true,
  "is_active": true
}

// 3. 普通用户角色
{
  "name": "user",
  "display_name": "普通用户",
  "description": "普通用户，只能查看数据",
  "permissions": [
    "files.view",
    "annotations.view"
  ],
  "is_system": true,
  "is_active": true
}
```

#### 默认管理员账户

```javascript
{
  "username": "admin",
  "email": "admin@example.com",
  "password_hash": "$2b$12$...",  // 默认密码: admin123 (需在首次登录后强制修改)
  "role_id": ObjectId("admin_role_id"),
  "is_active": true,
  "is_deleted": false,
  "created_at": ISODate(),
  "updated_at": ISODate(),
  "metadata": {
    "full_name": "系统管理员",
    "department": "IT部门"
  }
}
```

---

## 3. API 设计

### 3.1 认证相关 API

#### POST /api/auth/register
**描述**: 用户注册
**权限**: 公开

**请求体**:
```json
{
  "username": "string",
  "email": "string (optional)",
  "password": "string",
  "full_name": "string (optional)"
}
```

**响应**:
```json
{
  "user_id": "string",
  "username": "string",
  "role": "string",
  "message": "注册成功"
}
```

#### POST /api/auth/login
**描述**: 用户登录
**权限**: 公开

**请求体**:
```json
{
  "username": "string",
  "password": "string"
}
```

**响应**:
```json
{
  "access_token": "string (JWT)",
  "token_type": "Bearer",
  "user": {
    "id": "string",
    "username": "string",
    "role": {
      "name": "string",
      "display_name": "string",
      "permissions": ["string"]
    }
  }
}
```

#### POST /api/auth/logout
**描述**: 用户登出
**权限**: 已登录用户

**响应**:
```json
{
  "message": "登出成功"
}
```

#### GET /api/auth/me
**描述**: 获取当前用户信息
**权限**: 已登录用户

**响应**:
```json
{
  "id": "string",
  "username": "string",
  "email": "string",
  "role": {
    "name": "string",
    "display_name": "string",
    "permissions": ["string"]
  },
  "metadata": {
    "full_name": "string",
    "department": "string"
  }
}
```

#### PUT /api/auth/change-password
**描述**: 修改密码
**权限**: 已登录用户

**请求体**:
```json
{
  "old_password": "string",
  "new_password": "string"
}
```

---

### 3.2 用户管理 API

#### GET /api/users
**描述**: 获取用户列表
**权限**: `users.view`

**查询参数**:
- `page`: 页码 (default: 1)
- `page_size`: 每页数量 (default: 20)
- `role`: 角色筛选
- `is_active`: 激活状态筛选

**响应**:
```json
{
  "total": 100,
  "page": 1,
  "page_size": 20,
  "users": [
    {
      "id": "string",
      "username": "string",
      "email": "string",
      "role": {
        "id": "string",
        "name": "string",
        "display_name": "string"
      },
      "is_active": true,
      "created_at": "ISO8601",
      "last_login_at": "ISO8601"
    }
  ]
}
```

#### GET /api/users/{user_id}
**描述**: 获取用户详情
**权限**: `users.view` 或当前用户自己

#### POST /api/users
**描述**: 创建用户
**权限**: `users.create`

**请求体**:
```json
{
  "username": "string",
  "email": "string (optional)",
  "password": "string",
  "role_id": "string",
  "metadata": {
    "full_name": "string",
    "phone": "string",
    "department": "string"
  }
}
```

#### PUT /api/users/{user_id}
**描述**: 更新用户信息
**权限**: `users.update` 或当前用户自己（部分字段）

**请求体**:
```json
{
  "email": "string (optional)",
  "role_id": "string (optional, 需要 users.update 权限)",
  "is_active": "boolean (optional, 需要 users.update 权限)",
  "metadata": {
    "full_name": "string",
    "phone": "string",
    "department": "string"
  }
}
```

#### DELETE /api/users/{user_id}
**描述**: 删除用户（软删除）
**权限**: `users.delete`

---

### 3.3 角色管理 API

#### GET /api/roles
**描述**: 获取角色列表
**权限**: `roles.view`

**响应**:
```json
{
  "roles": [
    {
      "id": "string",
      "name": "string",
      "display_name": "string",
      "description": "string",
      "permissions": ["string"],
      "is_system": true,
      "is_active": true
    }
  ]
}
```

#### GET /api/roles/{role_id}
**描述**: 获取角色详情
**权限**: `roles.view`

#### POST /api/roles
**描述**: 创建角色
**权限**: `roles.create`

**请求体**:
```json
{
  "name": "string",
  "display_name": "string",
  "description": "string",
  "permissions": ["string"]
}
```

#### PUT /api/roles/{role_id}
**描述**: 更新角色
**权限**: `roles.update`
**限制**: 系统预设角色 (`is_system: true`) 不可修改 name，但可修改 permissions

**请求体**:
```json
{
  "display_name": "string (optional)",
  "description": "string (optional)",
  "permissions": ["string (optional)"],
  "is_active": "boolean (optional)"
}
```

#### DELETE /api/roles/{role_id}
**描述**: 删除角色
**权限**: `roles.delete`
**限制**: 系统预设角色不可删除

#### GET /api/permissions
**描述**: 获取所有可用权限列表
**权限**: `roles.view`

**响应**:
```json
{
  "permissions": [
    {
      "key": "users.view",
      "description": "查看用户列表",
      "category": "用户管理"
    }
  ]
}
```

---

## 4. 认证授权架构

### 4.1 JWT Token 结构

```json
{
  "sub": "user_id",
  "username": "string",
  "role_id": "string",
  "role_name": "string",
  "permissions": ["string"],
  "exp": 1234567890,
  "iat": 1234567890
}
```

### 4.2 认证流程

```mermaid
sequenceDiagram
    participant Client as 前端
    participant API as API Server
    participant DB as MongoDB

    Client->>API: POST /api/auth/login (username, password)
    API->>DB: 查询用户
    DB-->>API: 返回用户信息
    API->>API: 验证密码 (bcrypt)
    API->>DB: 查询用户角色和权限
    DB-->>API: 返回角色权限
    API->>API: 生成 JWT Token
    API-->>Client: 返回 Token 和用户信息

    Client->>API: GET /api/xxx (Header: Authorization: Bearer <token>)
    API->>API: 验证 JWT Token
    API->>API: 检查权限
    API->>DB: 执行业务逻辑
    DB-->>API: 返回数据
    API-->>Client: 返回响应
```

### 4.3 权限检查流程

```python
# 伪代码示例
def require_permission(permission: str):
    def decorator(func):
        async def wrapper(request: Request, *args, **kwargs):
            # 1. 从 request.state 获取当前用户（由 AuthMiddleware 设置）
            current_user = request.state.user

            # 2. 获取用户权限列表
            user_permissions = current_user.role.permissions

            # 3. 检查是否有所需权限
            if permission not in user_permissions:
                raise HTTPException(status_code=403, detail="权限不足")

            # 4. 执行原函数
            return await func(request, *args, **kwargs)
        return wrapper
    return decorator

# 使用示例
@app.get("/api/users")
@require_permission("users.view")
async def get_users(request: Request):
    # ... 业务逻辑
    pass
```

---

## 5. 实现指南

### 5.1 后端实现步骤

#### Step 1: 创建数据模型

文件: `backend/app/models/user.py`
```python
from pydantic import BaseModel, Field, EmailStr
from typing import Optional, List
from datetime import datetime
from bson import ObjectId

class UserMetadata(BaseModel):
    full_name: Optional[str] = None
    phone: Optional[str] = None
    department: Optional[str] = None

class User(BaseModel):
    id: str = Field(alias="_id")
    username: str
    email: Optional[EmailStr] = None
    password_hash: str
    role_id: str
    is_active: bool = True
    is_deleted: bool = False
    created_at: datetime
    updated_at: datetime
    last_login_at: Optional[datetime] = None
    metadata: Optional[UserMetadata] = None
```

文件: `backend/app/models/role.py`
```python
from pydantic import BaseModel, Field
from typing import List, Optional
from datetime import datetime

class Role(BaseModel):
    id: str = Field(alias="_id")
    name: str
    display_name: str
    description: Optional[str] = None
    permissions: List[str] = []
    is_system: bool = False
    is_active: bool = True
    created_at: datetime
    updated_at: datetime
```

#### Step 2: 创建 Repository 层

文件: `backend/app/db/repositories/user_repo.py`
```python
from motor.motor_asyncio import AsyncIOMotorDatabase
from typing import Optional, List
from bson import ObjectId
import bcrypt

class UserRepository:
    def __init__(self, db: AsyncIOMotorDatabase):
        self.collection = db["users"]

    async def find_by_username(self, username: str) -> Optional[dict]:
        return await self.collection.find_one({"username": username, "is_deleted": False})

    async def create(self, user_data: dict) -> str:
        # 密码加密
        password = user_data.pop("password")
        user_data["password_hash"] = bcrypt.hashpw(password.encode(), bcrypt.gensalt()).decode()

        result = await self.collection.insert_one(user_data)
        return str(result.inserted_id)

    async def verify_password(self, username: str, password: str) -> bool:
        user = await self.find_by_username(username)
        if not user:
            return False
        return bcrypt.checkpw(password.encode(), user["password_hash"].encode())

    # ... 其他方法
```

文件: `backend/app/db/repositories/role_repo.py`
```python
class RoleRepository:
    def __init__(self, db: AsyncIOMotorDatabase):
        self.collection = db["roles"]

    async def find_by_id(self, role_id: str) -> Optional[dict]:
        return await self.collection.find_one({"_id": ObjectId(role_id)})

    async def find_by_name(self, name: str) -> Optional[dict]:
        return await self.collection.find_one({"name": name})

    async def list_all(self, include_inactive: bool = False) -> List[dict]:
        query = {} if include_inactive else {"is_active": True}
        cursor = self.collection.find(query)
        return await cursor.to_list(length=None)

    # ... 其他方法
```

#### Step 3: 创建认证服务

文件: `backend/app/services/auth_service.py`
```python
from datetime import datetime, timedelta
import jwt
from app.config import settings
from app.db.repositories.user_repo import UserRepository
from app.db.repositories.role_repo import RoleRepository

class AuthService:
    @staticmethod
    def create_access_token(user_id: str, username: str, role_id: str,
                           role_name: str, permissions: List[str]) -> str:
        payload = {
            "sub": user_id,
            "username": username,
            "role_id": role_id,
            "role_name": role_name,
            "permissions": permissions,
            "exp": datetime.utcnow() + timedelta(days=settings.JWT_EXPIRATION_DAYS),
            "iat": datetime.utcnow()
        }
        return jwt.encode(payload, settings.JWT_SECRET_KEY, algorithm=settings.JWT_ALGORITHM)

    @staticmethod
    def verify_token(token: str) -> Optional[dict]:
        try:
            payload = jwt.decode(token, settings.JWT_SECRET_KEY,
                                algorithms=[settings.JWT_ALGORITHM])
            return payload
        except jwt.ExpiredSignatureError:
            return None
        except jwt.InvalidTokenError:
            return None

    @staticmethod
    async def authenticate_user(db, username: str, password: str) -> Optional[dict]:
        user_repo = UserRepository(db)
        role_repo = RoleRepository(db)

        # 验证用户名密码
        if not await user_repo.verify_password(username, password):
            return None

        # 获取用户信息
        user = await user_repo.find_by_username(username)
        if not user or not user["is_active"]:
            return None

        # 获取角色权限
        role = await role_repo.find_by_id(user["role_id"])
        if not role or not role["is_active"]:
            return None

        # 更新最后登录时间
        await user_repo.update_last_login(str(user["_id"]))

        return {
            "user": user,
            "role": role
        }
```

#### Step 4: 更新 AuthMiddleware

文件: `backend/app/middleware/auth.py`
```python
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.requests import Request
from starlette.responses import JSONResponse
from app.services.auth_service import AuthService

class AuthMiddleware(BaseHTTPMiddleware):
    # 不需要认证的路径
    EXCLUDE_PATHS = [
        "/",
        "/health",
        "/docs",
        "/openapi.json",
        "/api/auth/login",
        "/api/auth/register"
    ]

    async def dispatch(self, request: Request, call_next):
        # 检查是否在排除列表中
        if request.url.path in self.EXCLUDE_PATHS:
            return await call_next(request)

        # 获取 Authorization header
        auth_header = request.headers.get("Authorization")
        if not auth_header or not auth_header.startswith("Bearer "):
            return JSONResponse(
                status_code=401,
                content={"detail": "未提供认证令牌"}
            )

        # 验证 JWT Token
        token = auth_header.split(" ")[1]
        payload = AuthService.verify_token(token)
        if not payload:
            return JSONResponse(
                status_code=401,
                content={"detail": "令牌无效或已过期"}
            )

        # 将用户信息存入 request.state
        request.state.user_id = payload["sub"]
        request.state.username = payload["username"]
        request.state.role_id = payload["role_id"]
        request.state.role_name = payload["role_name"]
        request.state.permissions = payload["permissions"]

        return await call_next(request)
```

#### Step 5: 创建权限装饰器

文件: `backend/app/utils/permissions.py`
```python
from functools import wraps
from fastapi import HTTPException, Request

def require_permission(permission: str):
    """权限检查装饰器"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # 从参数中找到 Request 对象
            request = None
            for arg in args:
                if isinstance(arg, Request):
                    request = arg
                    break

            if not request:
                raise HTTPException(status_code=500, detail="Internal error")

            # 检查权限
            user_permissions = getattr(request.state, "permissions", [])
            if permission not in user_permissions:
                raise HTTPException(
                    status_code=403,
                    detail=f"权限不足，需要权限: {permission}"
                )

            return await func(*args, **kwargs)
        return wrapper
    return decorator

def get_current_user(request: Request) -> dict:
    """获取当前用户信息"""
    return {
        "user_id": request.state.user_id,
        "username": request.state.username,
        "role_id": request.state.role_id,
        "role_name": request.state.role_name,
        "permissions": request.state.permissions
    }
```

#### Step 6: 创建 API 路由

文件: `backend/app/api/auth.py`
```python
from fastapi import APIRouter, Depends, HTTPException, Request
from motor.motor_asyncio import AsyncIOMotorDatabase
from app.db import get_database
from app.services.auth_service import AuthService
from app.db.repositories.user_repo import UserRepository
from app.db.repositories.role_repo import RoleRepository
from pydantic import BaseModel

router = APIRouter(prefix="/api/auth", tags=["认证"])

class LoginRequest(BaseModel):
    username: str
    password: str

class RegisterRequest(BaseModel):
    username: str
    password: str
    email: Optional[str] = None
    full_name: Optional[str] = None

@router.post("/login")
async def login(
    data: LoginRequest,
    db: AsyncIOMotorDatabase = Depends(get_database)
):
    # 认证用户
    auth_result = await AuthService.authenticate_user(db, data.username, data.password)
    if not auth_result:
        raise HTTPException(status_code=401, detail="用户名或密码错误")

    user = auth_result["user"]
    role = auth_result["role"]

    # 生成 Token
    token = AuthService.create_access_token(
        user_id=str(user["_id"]),
        username=user["username"],
        role_id=str(role["_id"]),
        role_name=role["name"],
        permissions=role["permissions"]
    )

    return {
        "access_token": token,
        "token_type": "Bearer",
        "user": {
            "id": str(user["_id"]),
            "username": user["username"],
            "role": {
                "name": role["name"],
                "display_name": role["display_name"],
                "permissions": role["permissions"]
            }
        }
    }

@router.post("/register")
async def register(
    data: RegisterRequest,
    db: AsyncIOMotorDatabase = Depends(get_database)
):
    user_repo = UserRepository(db)
    role_repo = RoleRepository(db)

    # 检查用户名是否已存在
    existing = await user_repo.find_by_username(data.username)
    if existing:
        raise HTTPException(status_code=400, detail="用户名已存在")

    # 获取默认角色 (普通用户)
    default_role = await role_repo.find_by_name("user")
    if not default_role:
        raise HTTPException(status_code=500, detail="系统配置错误")

    # 创建用户
    user_data = {
        "username": data.username,
        "password": data.password,
        "email": data.email,
        "role_id": str(default_role["_id"]),
        "is_active": True,
        "is_deleted": False,
        "created_at": datetime.utcnow(),
        "updated_at": datetime.utcnow(),
        "metadata": {
            "full_name": data.full_name
        }
    }

    user_id = await user_repo.create(user_data)

    return {
        "user_id": user_id,
        "username": data.username,
        "role": default_role["name"],
        "message": "注册成功"
    }

@router.get("/me")
async def get_current_user_info(request: Request):
    """获取当前用户信息（需要认证）"""
    from app.utils.permissions import get_current_user
    return get_current_user(request)
```

文件: `backend/app/api/users.py`
```python
from fastapi import APIRouter, Depends, HTTPException, Request
from motor.motor_asyncio import AsyncIOMotorDatabase
from app.db import get_database
from app.utils.permissions import require_permission
from app.db.repositories.user_repo import UserRepository

router = APIRouter(prefix="/api/users", tags=["用户管理"])

@router.get("")
@require_permission("users.view")
async def list_users(
    request: Request,
    db: AsyncIOMotorDatabase = Depends(get_database),
    page: int = 1,
    page_size: int = 20
):
    user_repo = UserRepository(db)
    total, users = await user_repo.list_with_pagination(page, page_size)

    return {
        "total": total,
        "page": page,
        "page_size": page_size,
        "users": users
    }

# ... 其他用户管理 API
```

文件: `backend/app/api/roles.py`
```python
from fastapi import APIRouter, Depends, HTTPException, Request
from motor.motor_asyncio import AsyncIOMotorDatabase
from app.db import get_database
from app.utils.permissions import require_permission
from app.db.repositories.role_repo import RoleRepository

router = APIRouter(prefix="/api/roles", tags=["角色管理"])

@router.get("")
@require_permission("roles.view")
async def list_roles(
    request: Request,
    db: AsyncIOMotorDatabase = Depends(get_database)
):
    role_repo = RoleRepository(db)
    roles = await role_repo.list_all()
    return {"roles": roles}

# ... 其他角色管理 API
```

#### Step 7: 初始化脚本

文件: `backend/scripts/init_auth_system.py`
```python
#!/usr/bin/env python3
"""初始化用户权限系统"""
import asyncio
from motor.motor_asyncio import AsyncIOMotorClient
from datetime import datetime
from bson import ObjectId
import bcrypt

MONGODB_URI = "your_mongodb_uri"
DATABASE_NAME = "waveform-annotation-system"

async def init_auth_system():
    client = AsyncIOMotorClient(MONGODB_URI)
    db = client[DATABASE_NAME]

    print("🚀 开始初始化用户权限系统...")

    # 1. 创建角色
    print("📝 创建预设角色...")
    roles_collection = db["roles"]

    # 删除现有角色（如果存在）
    await roles_collection.delete_many({"is_system": True})

    # 插入预设角色
    admin_role_id = ObjectId()
    annotator_role_id = ObjectId()
    user_role_id = ObjectId()

    roles = [
        {
            "_id": admin_role_id,
            "name": "admin",
            "display_name": "管理员",
            "description": "系统管理员，拥有所有权限",
            "permissions": [
                "users.view", "users.create", "users.update", "users.delete",
                "files.view", "files.upload", "files.delete",
                "annotations.view", "annotations.create", "annotations.update",
                "annotations.delete", "annotations.export",
                "templates.view", "templates.create", "templates.update", "templates.delete",
                "roles.view", "roles.create", "roles.update", "roles.delete",
                "system.settings", "system.logs"
            ],
            "is_system": True,
            "is_active": True,
            "created_at": datetime.utcnow(),
            "updated_at": datetime.utcnow()
        },
        {
            "_id": annotator_role_id,
            "name": "annotator",
            "display_name": "标注员",
            "description": "负责数据标注的用户",
            "permissions": [
                "files.view",
                "annotations.view", "annotations.create", "annotations.update",
                "templates.view"
            ],
            "is_system": True,
            "is_active": True,
            "created_at": datetime.utcnow(),
            "updated_at": datetime.utcnow()
        },
        {
            "_id": user_role_id,
            "name": "user",
            "display_name": "普通用户",
            "description": "普通用户，只能查看数据",
            "permissions": [
                "files.view",
                "annotations.view"
            ],
            "is_system": True,
            "is_active": True,
            "created_at": datetime.utcnow(),
            "updated_at": datetime.utcnow()
        }
    ]

    await roles_collection.insert_many(roles)
    print("✅ 预设角色创建成功")

    # 2. 创建默认管理员账户
    print("👤 创建默认管理员账户...")
    users_collection = db["users"]

    # 删除现有admin用户（如果存在）
    await users_collection.delete_one({"username": "admin"})

    # 创建admin账户
    password_hash = bcrypt.hashpw(b"admin123", bcrypt.gensalt()).decode()

    admin_user = {
        "username": "admin",
        "email": "admin@example.com",
        "password_hash": password_hash,
        "role_id": str(admin_role_id),
        "is_active": True,
        "is_deleted": False,
        "created_at": datetime.utcnow(),
        "updated_at": datetime.utcnow(),
        "metadata": {
            "full_name": "系统管理员",
            "department": "IT部门"
        }
    }

    await users_collection.insert_one(admin_user)
    print("✅ 默认管理员创建成功")
    print("   用户名: admin")
    print("   密码: admin123")
    print("   ⚠️  请在首次登录后立即修改密码！")

    # 3. 创建索引
    print("🔍 创建数据库索引...")
    await users_collection.create_index("username", unique=True)
    await users_collection.create_index("email", unique=True, sparse=True)
    await users_collection.create_index("role_id")
    await roles_collection.create_index("name", unique=True)
    print("✅ 索引创建成功")

    print("🎉 用户权限系统初始化完成！")

    client.close()

if __name__ == "__main__":
    asyncio.run(init_auth_system())
```

运行初始化脚本:
```bash
cd backend
python scripts/init_auth_system.py
```

#### Step 8: 更新 main.py

```python
# backend/app/main.py
from app.api import files, annotations, templates, auth, users, roles

# 注册新的路由
app.include_router(auth.router)
app.include_router(users.router)
app.include_router(roles.router)
```

---

### 5.2 前端实现步骤

#### Step 1: 创建认证 Store

文件: `frontend/src/store/authStore.ts`
```typescript
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

interface User {
  id: string
  username: string
  role: {
    name: string
    display_name: string
    permissions: string[]
  }
}

interface AuthState {
  user: User | null
  token: string | null
  isAuthenticated: boolean

  login: (username: string, password: string) => Promise<void>
  logout: () => void
  hasPermission: (permission: string) => boolean
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      token: null,
      isAuthenticated: false,

      login: async (username, password) => {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        })

        if (!response.ok) {
          throw new Error('登录失败')
        }

        const data = await response.json()

        set({
          user: data.user,
          token: data.access_token,
          isAuthenticated: true
        })
      },

      logout: () => {
        set({
          user: null,
          token: null,
          isAuthenticated: false
        })
      },

      hasPermission: (permission: string) => {
        const { user } = get()
        return user?.role.permissions.includes(permission) ?? false
      }
    }),
    {
      name: 'auth-storage'
    }
  )
)
```

#### Step 2: 创建 API 客户端

文件: `frontend/src/services/api.ts`
```typescript
import { useAuthStore } from '../store/authStore'

// 添加认证拦截器
export const apiClient = {
  async request(url: string, options: RequestInit = {}) {
    const token = useAuthStore.getState().token

    const headers = {
      'Content-Type': 'application/json',
      ...(token && { 'Authorization': `Bearer ${token}` }),
      ...options.headers
    }

    const response = await fetch(url, {
      ...options,
      headers
    })

    // 处理 401 未授权
    if (response.status === 401) {
      useAuthStore.getState().logout()
      window.location.href = '/login'
    }

    return response
  }
}
```

#### Step 3: 创建登录页面

文件: `frontend/src/pages/LoginPage.tsx`
```typescript
import { useState } from 'react'
import { useNavigate } from 'react-router-dom'
import { useAuthStore } from '../store/authStore'

export default function LoginPage() {
  const [username, setUsername] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)

  const { login } = useAuthStore()
  const navigate = useNavigate()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')
    setLoading(true)

    try {
      await login(username, password)
      navigate('/')
    } catch (err) {
      setError('用户名或密码错误')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
        <h1 className="text-2xl font-bold text-center mb-6">
          波形标注系统
        </h1>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              用户名
            </label>
            <input
              type="text"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              密码
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md"
              required
            />
          </div>

          {error && (
            <div className="text-sm text-red-600">{error}</div>
          )}

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 disabled:opacity-50"
          >
            {loading ? '登录中...' : '登录'}
          </button>
        </form>
      </div>
    </div>
  )
}
```

#### Step 4: 创建权限组件

文件: `frontend/src/components/PermissionGate.tsx`
```typescript
import { useAuthStore } from '../store/authStore'

interface PermissionGateProps {
  permission: string
  fallback?: React.ReactNode
  children: React.ReactNode
}

export function PermissionGate({ permission, fallback = null, children }: PermissionGateProps) {
  const hasPermission = useAuthStore((state) => state.hasPermission(permission))

  if (!hasPermission) {
    return <>{fallback}</>
  }

  return <>{children}</>
}
```

#### Step 5: 创建路由守卫

文件: `frontend/src/App.tsx`
```typescript
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom'
import { useAuthStore } from './store/authStore'
import LoginPage from './pages/LoginPage'
import WorkspacePage from './pages/WorkspacePage'

function ProtectedRoute({ children }: { children: React.ReactNode }) {
  const isAuthenticated = useAuthStore((state) => state.isAuthenticated)

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />
  }

  return <>{children}</>
}

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/login" element={<LoginPage />} />
        <Route
          path="/"
          element={
            <ProtectedRoute>
              <WorkspacePage />
            </ProtectedRoute>
          }
        />
      </Routes>
    </BrowserRouter>
  )
}

export default App
```

---

## 6. 配置示例

### 6.1 环境变量配置

文件: `backend/.env`
```env
# MongoDB
MONGODB_URI=mongodb://username:password@host:port/
MONGODB_DATABASE=waveform-annotation-system

# JWT
JWT_SECRET_KEY=your-very-secure-secret-key-change-in-production
JWT_ALGORITHM=HS256
JWT_EXPIRATION_DAYS=7

# 其他配置
H5_DATA_PATH=../dataset
CORS_ORIGINS=["http://localhost:5173"]
```

### 6.2 权限配置文件

文件: `backend/app/config/permissions.py`
```python
# 所有可用权限定义
ALL_PERMISSIONS = {
    "users.view": {"description": "查看用户列表", "category": "用户管理"},
    "users.create": {"description": "创建用户", "category": "用户管理"},
    "users.update": {"description": "更新用户", "category": "用户管理"},
    "users.delete": {"description": "删除用户", "category": "用户管理"},

    "files.view": {"description": "查看文件", "category": "文件管理"},
    "files.upload": {"description": "上传文件", "category": "文件管理"},
    "files.delete": {"description": "删除文件", "category": "文件管理"},

    "annotations.view": {"description": "查看标注", "category": "标注管理"},
    "annotations.create": {"description": "创建标注", "category": "标注管理"},
    "annotations.update": {"description": "更新标注", "category": "标注管理"},
    "annotations.delete": {"description": "删除标注", "category": "标注管理"},
    "annotations.export": {"description": "导出标注", "category": "标注管理"},

    "templates.view": {"description": "查看模板", "category": "模板管理"},
    "templates.create": {"description": "创建模板", "category": "模板管理"},
    "templates.update": {"description": "更新模板", "category": "模板管理"},
    "templates.delete": {"description": "删除模板", "category": "模板管理"},

    "roles.view": {"description": "查看角色", "category": "角色管理"},
    "roles.create": {"description": "创建角色", "category": "角色管理"},
    "roles.update": {"description": "更新角色", "category": "角色管理"},
    "roles.delete": {"description": "删除角色", "category": "角色管理"},

    "system.settings": {"description": "系统设置", "category": "系统管理"},
    "system.logs": {"description": "系统日志", "category": "系统管理"}
}

# 预设角色权限配置
ROLE_PRESETS = {
    "admin": list(ALL_PERMISSIONS.keys()),  # 所有权限
    "annotator": [
        "files.view",
        "annotations.view", "annotations.create", "annotations.update",
        "templates.view"
    ],
    "user": [
        "files.view",
        "annotations.view"
    ]
}
```

---

## 7. 安全建议

### 7.1 密码安全
- 使用 bcrypt 加密密码（已包含）
- 强制密码复杂度要求（建议实现）
- 首次登录强制修改默认密码（建议实现）
- 密码重试次数限制（建议实现）

### 7.2 Token 安全
- JWT Secret Key 必须使用强随机字符串
- Token 有效期不宜过长（当前 7 天，可调整）
- 考虑实现 Refresh Token 机制
- 敏感操作需要重新验证

### 7.3 API 安全
- 所有 API 默认需要认证
- 权限检查在每个操作前执行
- 输入验证和参数校验
- 防止 SQL 注入和 XSS 攻击

### 7.4 数据安全
- 用户密码不可明文存储
- 敏感信息加密传输（HTTPS）
- 定期备份数据库
- 审计日志记录（建议实现）

---

## 8. 测试建议

### 8.1 单元测试
```python
# tests/test_auth_service.py
import pytest
from app.services.auth_service import AuthService

def test_create_access_token():
    token = AuthService.create_access_token(
        user_id="123",
        username="test",
        role_id="456",
        role_name="admin",
        permissions=["users.view"]
    )
    assert token is not None

def test_verify_token():
    token = AuthService.create_access_token(...)
    payload = AuthService.verify_token(token)
    assert payload["username"] == "test"
```

### 8.2 集成测试
```python
# tests/test_auth_api.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_login_success():
    response = client.post("/api/auth/login", json={
        "username": "admin",
        "password": "admin123"
    })
    assert response.status_code == 200
    assert "access_token" in response.json()

def test_login_failure():
    response = client.post("/api/auth/login", json={
        "username": "admin",
        "password": "wrong_password"
    })
    assert response.status_code == 401
```

---

## 9. 维护和扩展

### 9.1 添加新权限
1. 在 `permissions.py` 的 `ALL_PERMISSIONS` 中添加新权限
2. 更新相关角色的权限列表
3. 在 API 中使用 `@require_permission("new.permission")` 保护端点

### 9.2 创建自定义角色
1. 使用管理员账户登录
2. 调用 `POST /api/roles` 创建新角色
3. 从 `ALL_PERMISSIONS` 中选择需要的权限
4. 将用户分配到新角色

### 9.3 数据迁移
- 使用 MongoDB 的备份恢复功能
- 注意保持 users 和 roles 的关联关系
- 迁移前验证索引完整性

---

## 10. 常见问题

### Q1: 如何重置管理员密码？
```python
# 在 MongoDB shell 中执行
import bcrypt
new_password_hash = bcrypt.hashpw(b"new_password", bcrypt.gensalt()).decode()
db.users.update_one(
    {"username": "admin"},
    {"$set": {"password_hash": new_password_hash}}
)
```

### Q2: 如何给现有用户分配权限？
通过修改用户的 `role_id`，或者创建/修改角色的权限列表

### Q3: Token 过期后怎么办？
需要重新登录获取新 Token，或实现 Refresh Token 机制

### Q4: 如何查看当前所有权限？
调用 `GET /api/permissions` API（需要 `roles.view` 权限）

---

## 11. 下一步改进建议

1. **实现 Refresh Token 机制** - 提升用户体验
2. **添加审计日志** - 记录所有敏感操作
3. **密码策略配置** - 强制密码复杂度和定期更换
4. **多因素认证 (MFA)** - 提升安全性
5. **OAuth2 集成** - 支持第三方登录
6. **会话管理** - 支持踢出在线用户
7. **权限继承** - 支持角色继承机制
8. **前端权限UI** - 可视化权限配置界面

---

## 12. 总结

本设计文档提供了一个完整的用户权限系统实现方案，包括：

✅ **数据库设计** - MongoDB schema 和索引
✅ **API 设计** - RESTful API 规范
✅ **认证授权** - JWT + RBAC 权限控制
✅ **默认配置** - 三个预设角色和管理员账户
✅ **实现指南** - 完整的代码示例
✅ **安全建议** - 安全最佳实践
✅ **测试建议** - 单元测试和集成测试

按照本文档的步骤实施，可以快速搭建一个安全、可扩展的用户权限系统。
