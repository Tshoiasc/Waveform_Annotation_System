# ç”¨æˆ·æƒé™ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 éœ€æ±‚åˆ†æ
- è´¦å·å¯†ç ç™»å½•è®¤è¯
- ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
- é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
- åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ (RBAC)
- ä¸‰ç§é¢„è®¾è§’è‰²ï¼šç®¡ç†å‘˜ã€æ ‡æ³¨å‘˜ã€æ™®é€šç”¨æˆ·
- æ”¯æŒè‡ªå®šä¹‰æƒé™é…ç½®

### 1.2 æŠ€æœ¯æ ˆ
- **åç«¯**: FastAPI + Motor (å¼‚æ­¥ MongoDB)
- **æ•°æ®åº“**: MongoDB
- **è®¤è¯**: JWT (JSON Web Token)
- **å¯†ç åŠ å¯†**: bcrypt
- **å‰ç«¯**: React + TypeScript

---

## 2. æ•°æ®åº“è®¾è®¡

### 2.1 Users é›†åˆ (ç”¨æˆ·è¡¨)

```javascript
{
  "_id": ObjectId,                    // MongoDB è‡ªåŠ¨ç”Ÿæˆ
  "username": String,                 // ç”¨æˆ·åï¼Œå”¯ä¸€
  "email": String,                    // é‚®ç®±ï¼Œå”¯ä¸€ï¼Œå¯é€‰
  "password_hash": String,            // bcrypt åŠ å¯†åçš„å¯†ç 
  "role_id": ObjectId,                // å…³è”åˆ° roles é›†åˆ
  "is_active": Boolean,               // è´¦æˆ·æ˜¯å¦æ¿€æ´»
  "is_deleted": Boolean,              // è½¯åˆ é™¤æ ‡è®°
  "created_at": ISODate,              // åˆ›å»ºæ—¶é—´
  "updated_at": ISODate,              // æ›´æ–°æ—¶é—´
  "last_login_at": ISODate,           // æœ€åç™»å½•æ—¶é—´
  "metadata": {                       // æ‰©å±•ä¿¡æ¯
    "full_name": String,              // çœŸå®å§“å
    "phone": String,                  // è”ç³»ç”µè¯
    "department": String              // éƒ¨é—¨
  }
}
```

**ç´¢å¼•è®¾è®¡**:
```javascript
db.users.createIndex({ "username": 1 }, { unique: true })
db.users.createIndex({ "email": 1 }, { unique: true, sparse: true })
db.users.createIndex({ "role_id": 1 })
db.users.createIndex({ "is_active": 1, "is_deleted": 1 })
```

### 2.2 Roles é›†åˆ (è§’è‰²è¡¨)

```javascript
{
  "_id": ObjectId,
  "name": String,                     // è§’è‰²åç§°ï¼Œå”¯ä¸€
  "display_name": String,             // è§’è‰²æ˜¾ç¤ºåç§°
  "description": String,              // è§’è‰²æè¿°
  "permissions": [String],            // æƒé™åˆ—è¡¨
  "is_system": Boolean,               // æ˜¯å¦ç³»ç»Ÿé¢„è®¾è§’è‰²ï¼ˆä¸å¯åˆ é™¤ï¼‰
  "is_active": Boolean,               // æ˜¯å¦å¯ç”¨
  "created_at": ISODate,
  "updated_at": ISODate
}
```

**ç´¢å¼•è®¾è®¡**:
```javascript
db.roles.createIndex({ "name": 1 }, { unique: true })
db.roles.createIndex({ "is_system": 1 })
```

### 2.3 é¢„è®¾è§’è‰²å’Œæƒé™

#### æƒé™å®šä¹‰

```python
# æƒé™åˆ†ç±»
PERMISSIONS = {
    # ç”¨æˆ·ç®¡ç†
    "users.view": "æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨",
    "users.create": "åˆ›å»ºç”¨æˆ·",
    "users.update": "æ›´æ–°ç”¨æˆ·ä¿¡æ¯",
    "users.delete": "åˆ é™¤ç”¨æˆ·",

    # æ–‡ä»¶ç®¡ç†
    "files.view": "æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨",
    "files.upload": "ä¸Šä¼ æ–‡ä»¶",
    "files.delete": "åˆ é™¤æ–‡ä»¶",

    # æ ‡æ³¨ç®¡ç†
    "annotations.view": "æŸ¥çœ‹æ ‡æ³¨",
    "annotations.create": "åˆ›å»ºæ ‡æ³¨",
    "annotations.update": "æ›´æ–°æ ‡æ³¨",
    "annotations.delete": "åˆ é™¤æ ‡æ³¨",
    "annotations.export": "å¯¼å‡ºæ ‡æ³¨",

    # æ¨¡æ¿ç®¡ç†
    "templates.view": "æŸ¥çœ‹æ¨¡æ¿",
    "templates.create": "åˆ›å»ºæ¨¡æ¿",
    "templates.update": "æ›´æ–°æ¨¡æ¿",
    "templates.delete": "åˆ é™¤æ¨¡æ¿",

    # è§’è‰²ç®¡ç†
    "roles.view": "æŸ¥çœ‹è§’è‰²",
    "roles.create": "åˆ›å»ºè§’è‰²",
    "roles.update": "æ›´æ–°è§’è‰²",
    "roles.delete": "åˆ é™¤è§’è‰²",

    # ç³»ç»Ÿç®¡ç†
    "system.settings": "ç³»ç»Ÿè®¾ç½®",
    "system.logs": "æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"
}
```

#### é¢„è®¾è§’è‰²é…ç½®

```javascript
// 1. ç®¡ç†å‘˜è§’è‰²
{
  "name": "admin",
  "display_name": "ç®¡ç†å‘˜",
  "description": "ç³»ç»Ÿç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™",
  "permissions": [
    "users.view", "users.create", "users.update", "users.delete",
    "files.view", "files.upload", "files.delete",
    "annotations.view", "annotations.create", "annotations.update",
    "annotations.delete", "annotations.export",
    "templates.view", "templates.create", "templates.update", "templates.delete",
    "roles.view", "roles.create", "roles.update", "roles.delete",
    "system.settings", "system.logs"
  ],
  "is_system": true,
  "is_active": true
}

// 2. æ ‡æ³¨å‘˜è§’è‰²
{
  "name": "annotator",
  "display_name": "æ ‡æ³¨å‘˜",
  "description": "è´Ÿè´£æ•°æ®æ ‡æ³¨çš„ç”¨æˆ·",
  "permissions": [
    "files.view",
    "annotations.view", "annotations.create", "annotations.update",
    "templates.view"
  ],
  "is_system": true,
  "is_active": true
}

// 3. æ™®é€šç”¨æˆ·è§’è‰²
{
  "name": "user",
  "display_name": "æ™®é€šç”¨æˆ·",
  "description": "æ™®é€šç”¨æˆ·ï¼Œåªèƒ½æŸ¥çœ‹æ•°æ®",
  "permissions": [
    "files.view",
    "annotations.view"
  ],
  "is_system": true,
  "is_active": true
}
```

#### é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·

```javascript
{
  "username": "admin",
  "email": "admin@example.com",
  "password_hash": "$2b$12$...",  // é»˜è®¤å¯†ç : admin123 (éœ€åœ¨é¦–æ¬¡ç™»å½•åå¼ºåˆ¶ä¿®æ”¹)
  "role_id": ObjectId("admin_role_id"),
  "is_active": true,
  "is_deleted": false,
  "created_at": ISODate(),
  "updated_at": ISODate(),
  "metadata": {
    "full_name": "ç³»ç»Ÿç®¡ç†å‘˜",
    "department": "ITéƒ¨é—¨"
  }
}
```

---

## 3. API è®¾è®¡

### 3.1 è®¤è¯ç›¸å…³ API

#### POST /api/auth/register
**æè¿°**: ç”¨æˆ·æ³¨å†Œ
**æƒé™**: å…¬å¼€

**è¯·æ±‚ä½“**:
```json
{
  "username": "string",
  "email": "string (optional)",
  "password": "string",
  "full_name": "string (optional)"
}
```

**å“åº”**:
```json
{
  "user_id": "string",
  "username": "string",
  "role": "string",
  "message": "æ³¨å†ŒæˆåŠŸ"
}
```

#### POST /api/auth/login
**æè¿°**: ç”¨æˆ·ç™»å½•
**æƒé™**: å…¬å¼€

**è¯·æ±‚ä½“**:
```json
{
  "username": "string",
  "password": "string"
}
```

**å“åº”**:
```json
{
  "access_token": "string (JWT)",
  "token_type": "Bearer",
  "user": {
    "id": "string",
    "username": "string",
    "role": {
      "name": "string",
      "display_name": "string",
      "permissions": ["string"]
    }
  }
}
```

#### POST /api/auth/logout
**æè¿°**: ç”¨æˆ·ç™»å‡º
**æƒé™**: å·²ç™»å½•ç”¨æˆ·

**å“åº”**:
```json
{
  "message": "ç™»å‡ºæˆåŠŸ"
}
```

#### GET /api/auth/me
**æè¿°**: è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
**æƒé™**: å·²ç™»å½•ç”¨æˆ·

**å“åº”**:
```json
{
  "id": "string",
  "username": "string",
  "email": "string",
  "role": {
    "name": "string",
    "display_name": "string",
    "permissions": ["string"]
  },
  "metadata": {
    "full_name": "string",
    "department": "string"
  }
}
```

#### PUT /api/auth/change-password
**æè¿°**: ä¿®æ”¹å¯†ç 
**æƒé™**: å·²ç™»å½•ç”¨æˆ·

**è¯·æ±‚ä½“**:
```json
{
  "old_password": "string",
  "new_password": "string"
}
```

---

### 3.2 ç”¨æˆ·ç®¡ç† API

#### GET /api/users
**æè¿°**: è·å–ç”¨æˆ·åˆ—è¡¨
**æƒé™**: `users.view`

**æŸ¥è¯¢å‚æ•°**:
- `page`: é¡µç  (default: 1)
- `page_size`: æ¯é¡µæ•°é‡ (default: 20)
- `role`: è§’è‰²ç­›é€‰
- `is_active`: æ¿€æ´»çŠ¶æ€ç­›é€‰

**å“åº”**:
```json
{
  "total": 100,
  "page": 1,
  "page_size": 20,
  "users": [
    {
      "id": "string",
      "username": "string",
      "email": "string",
      "role": {
        "id": "string",
        "name": "string",
        "display_name": "string"
      },
      "is_active": true,
      "created_at": "ISO8601",
      "last_login_at": "ISO8601"
    }
  ]
}
```

#### GET /api/users/{user_id}
**æè¿°**: è·å–ç”¨æˆ·è¯¦æƒ…
**æƒé™**: `users.view` æˆ–å½“å‰ç”¨æˆ·è‡ªå·±

#### POST /api/users
**æè¿°**: åˆ›å»ºç”¨æˆ·
**æƒé™**: `users.create`

**è¯·æ±‚ä½“**:
```json
{
  "username": "string",
  "email": "string (optional)",
  "password": "string",
  "role_id": "string",
  "metadata": {
    "full_name": "string",
    "phone": "string",
    "department": "string"
  }
}
```

#### PUT /api/users/{user_id}
**æè¿°**: æ›´æ–°ç”¨æˆ·ä¿¡æ¯
**æƒé™**: `users.update` æˆ–å½“å‰ç”¨æˆ·è‡ªå·±ï¼ˆéƒ¨åˆ†å­—æ®µï¼‰

**è¯·æ±‚ä½“**:
```json
{
  "email": "string (optional)",
  "role_id": "string (optional, éœ€è¦ users.update æƒé™)",
  "is_active": "boolean (optional, éœ€è¦ users.update æƒé™)",
  "metadata": {
    "full_name": "string",
    "phone": "string",
    "department": "string"
  }
}
```

#### DELETE /api/users/{user_id}
**æè¿°**: åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
**æƒé™**: `users.delete`

---

### 3.3 è§’è‰²ç®¡ç† API

#### GET /api/roles
**æè¿°**: è·å–è§’è‰²åˆ—è¡¨
**æƒé™**: `roles.view`

**å“åº”**:
```json
{
  "roles": [
    {
      "id": "string",
      "name": "string",
      "display_name": "string",
      "description": "string",
      "permissions": ["string"],
      "is_system": true,
      "is_active": true
    }
  ]
}
```

#### GET /api/roles/{role_id}
**æè¿°**: è·å–è§’è‰²è¯¦æƒ…
**æƒé™**: `roles.view`

#### POST /api/roles
**æè¿°**: åˆ›å»ºè§’è‰²
**æƒé™**: `roles.create`

**è¯·æ±‚ä½“**:
```json
{
  "name": "string",
  "display_name": "string",
  "description": "string",
  "permissions": ["string"]
}
```

#### PUT /api/roles/{role_id}
**æè¿°**: æ›´æ–°è§’è‰²
**æƒé™**: `roles.update`
**é™åˆ¶**: ç³»ç»Ÿé¢„è®¾è§’è‰² (`is_system: true`) ä¸å¯ä¿®æ”¹ nameï¼Œä½†å¯ä¿®æ”¹ permissions

**è¯·æ±‚ä½“**:
```json
{
  "display_name": "string (optional)",
  "description": "string (optional)",
  "permissions": ["string (optional)"],
  "is_active": "boolean (optional)"
}
```

#### DELETE /api/roles/{role_id}
**æè¿°**: åˆ é™¤è§’è‰²
**æƒé™**: `roles.delete`
**é™åˆ¶**: ç³»ç»Ÿé¢„è®¾è§’è‰²ä¸å¯åˆ é™¤

#### GET /api/permissions
**æè¿°**: è·å–æ‰€æœ‰å¯ç”¨æƒé™åˆ—è¡¨
**æƒé™**: `roles.view`

**å“åº”**:
```json
{
  "permissions": [
    {
      "key": "users.view",
      "description": "æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨",
      "category": "ç”¨æˆ·ç®¡ç†"
    }
  ]
}
```

---

## 4. è®¤è¯æˆæƒæ¶æ„

### 4.1 JWT Token ç»“æ„

```json
{
  "sub": "user_id",
  "username": "string",
  "role_id": "string",
  "role_name": "string",
  "permissions": ["string"],
  "exp": 1234567890,
  "iat": 1234567890
}
```

### 4.2 è®¤è¯æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å‰ç«¯
    participant API as API Server
    participant DB as MongoDB

    Client->>API: POST /api/auth/login (username, password)
    API->>DB: æŸ¥è¯¢ç”¨æˆ·
    DB-->>API: è¿”å›ç”¨æˆ·ä¿¡æ¯
    API->>API: éªŒè¯å¯†ç  (bcrypt)
    API->>DB: æŸ¥è¯¢ç”¨æˆ·è§’è‰²å’Œæƒé™
    DB-->>API: è¿”å›è§’è‰²æƒé™
    API->>API: ç”Ÿæˆ JWT Token
    API-->>Client: è¿”å› Token å’Œç”¨æˆ·ä¿¡æ¯

    Client->>API: GET /api/xxx (Header: Authorization: Bearer <token>)
    API->>API: éªŒè¯ JWT Token
    API->>API: æ£€æŸ¥æƒé™
    API->>DB: æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    DB-->>API: è¿”å›æ•°æ®
    API-->>Client: è¿”å›å“åº”
```

### 4.3 æƒé™æ£€æŸ¥æµç¨‹

```python
# ä¼ªä»£ç ç¤ºä¾‹
def require_permission(permission: str):
    def decorator(func):
        async def wrapper(request: Request, *args, **kwargs):
            # 1. ä» request.state è·å–å½“å‰ç”¨æˆ·ï¼ˆç”± AuthMiddleware è®¾ç½®ï¼‰
            current_user = request.state.user

            # 2. è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
            user_permissions = current_user.role.permissions

            # 3. æ£€æŸ¥æ˜¯å¦æœ‰æ‰€éœ€æƒé™
            if permission not in user_permissions:
                raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")

            # 4. æ‰§è¡ŒåŸå‡½æ•°
            return await func(request, *args, **kwargs)
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@app.get("/api/users")
@require_permission("users.view")
async def get_users(request: Request):
    # ... ä¸šåŠ¡é€»è¾‘
    pass
```

---

## 5. å®ç°æŒ‡å—

### 5.1 åç«¯å®ç°æ­¥éª¤

#### Step 1: åˆ›å»ºæ•°æ®æ¨¡å‹

æ–‡ä»¶: `backend/app/models/user.py`
```python
from pydantic import BaseModel, Field, EmailStr
from typing import Optional, List
from datetime import datetime
from bson import ObjectId

class UserMetadata(BaseModel):
    full_name: Optional[str] = None
    phone: Optional[str] = None
    department: Optional[str] = None

class User(BaseModel):
    id: str = Field(alias="_id")
    username: str
    email: Optional[EmailStr] = None
    password_hash: str
    role_id: str
    is_active: bool = True
    is_deleted: bool = False
    created_at: datetime
    updated_at: datetime
    last_login_at: Optional[datetime] = None
    metadata: Optional[UserMetadata] = None
```

æ–‡ä»¶: `backend/app/models/role.py`
```python
from pydantic import BaseModel, Field
from typing import List, Optional
from datetime import datetime

class Role(BaseModel):
    id: str = Field(alias="_id")
    name: str
    display_name: str
    description: Optional[str] = None
    permissions: List[str] = []
    is_system: bool = False
    is_active: bool = True
    created_at: datetime
    updated_at: datetime
```

#### Step 2: åˆ›å»º Repository å±‚

æ–‡ä»¶: `backend/app/db/repositories/user_repo.py`
```python
from motor.motor_asyncio import AsyncIOMotorDatabase
from typing import Optional, List
from bson import ObjectId
import bcrypt

class UserRepository:
    def __init__(self, db: AsyncIOMotorDatabase):
        self.collection = db["users"]

    async def find_by_username(self, username: str) -> Optional[dict]:
        return await self.collection.find_one({"username": username, "is_deleted": False})

    async def create(self, user_data: dict) -> str:
        # å¯†ç åŠ å¯†
        password = user_data.pop("password")
        user_data["password_hash"] = bcrypt.hashpw(password.encode(), bcrypt.gensalt()).decode()

        result = await self.collection.insert_one(user_data)
        return str(result.inserted_id)

    async def verify_password(self, username: str, password: str) -> bool:
        user = await self.find_by_username(username)
        if not user:
            return False
        return bcrypt.checkpw(password.encode(), user["password_hash"].encode())

    # ... å…¶ä»–æ–¹æ³•
```

æ–‡ä»¶: `backend/app/db/repositories/role_repo.py`
```python
class RoleRepository:
    def __init__(self, db: AsyncIOMotorDatabase):
        self.collection = db["roles"]

    async def find_by_id(self, role_id: str) -> Optional[dict]:
        return await self.collection.find_one({"_id": ObjectId(role_id)})

    async def find_by_name(self, name: str) -> Optional[dict]:
        return await self.collection.find_one({"name": name})

    async def list_all(self, include_inactive: bool = False) -> List[dict]:
        query = {} if include_inactive else {"is_active": True}
        cursor = self.collection.find(query)
        return await cursor.to_list(length=None)

    # ... å…¶ä»–æ–¹æ³•
```

#### Step 3: åˆ›å»ºè®¤è¯æœåŠ¡

æ–‡ä»¶: `backend/app/services/auth_service.py`
```python
from datetime import datetime, timedelta
import jwt
from app.config import settings
from app.db.repositories.user_repo import UserRepository
from app.db.repositories.role_repo import RoleRepository

class AuthService:
    @staticmethod
    def create_access_token(user_id: str, username: str, role_id: str,
                           role_name: str, permissions: List[str]) -> str:
        payload = {
            "sub": user_id,
            "username": username,
            "role_id": role_id,
            "role_name": role_name,
            "permissions": permissions,
            "exp": datetime.utcnow() + timedelta(days=settings.JWT_EXPIRATION_DAYS),
            "iat": datetime.utcnow()
        }
        return jwt.encode(payload, settings.JWT_SECRET_KEY, algorithm=settings.JWT_ALGORITHM)

    @staticmethod
    def verify_token(token: str) -> Optional[dict]:
        try:
            payload = jwt.decode(token, settings.JWT_SECRET_KEY,
                                algorithms=[settings.JWT_ALGORITHM])
            return payload
        except jwt.ExpiredSignatureError:
            return None
        except jwt.InvalidTokenError:
            return None

    @staticmethod
    async def authenticate_user(db, username: str, password: str) -> Optional[dict]:
        user_repo = UserRepository(db)
        role_repo = RoleRepository(db)

        # éªŒè¯ç”¨æˆ·åå¯†ç 
        if not await user_repo.verify_password(username, password):
            return None

        # è·å–ç”¨æˆ·ä¿¡æ¯
        user = await user_repo.find_by_username(username)
        if not user or not user["is_active"]:
            return None

        # è·å–è§’è‰²æƒé™
        role = await role_repo.find_by_id(user["role_id"])
        if not role or not role["is_active"]:
            return None

        # æ›´æ–°æœ€åç™»å½•æ—¶é—´
        await user_repo.update_last_login(str(user["_id"]))

        return {
            "user": user,
            "role": role
        }
```

#### Step 4: æ›´æ–° AuthMiddleware

æ–‡ä»¶: `backend/app/middleware/auth.py`
```python
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.requests import Request
from starlette.responses import JSONResponse
from app.services.auth_service import AuthService

class AuthMiddleware(BaseHTTPMiddleware):
    # ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
    EXCLUDE_PATHS = [
        "/",
        "/health",
        "/docs",
        "/openapi.json",
        "/api/auth/login",
        "/api/auth/register"
    ]

    async def dispatch(self, request: Request, call_next):
        # æ£€æŸ¥æ˜¯å¦åœ¨æ’é™¤åˆ—è¡¨ä¸­
        if request.url.path in self.EXCLUDE_PATHS:
            return await call_next(request)

        # è·å– Authorization header
        auth_header = request.headers.get("Authorization")
        if not auth_header or not auth_header.startswith("Bearer "):
            return JSONResponse(
                status_code=401,
                content={"detail": "æœªæä¾›è®¤è¯ä»¤ç‰Œ"}
            )

        # éªŒè¯ JWT Token
        token = auth_header.split(" ")[1]
        payload = AuthService.verify_token(token)
        if not payload:
            return JSONResponse(
                status_code=401,
                content={"detail": "ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ"}
            )

        # å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ request.state
        request.state.user_id = payload["sub"]
        request.state.username = payload["username"]
        request.state.role_id = payload["role_id"]
        request.state.role_name = payload["role_name"]
        request.state.permissions = payload["permissions"]

        return await call_next(request)
```

#### Step 5: åˆ›å»ºæƒé™è£…é¥°å™¨

æ–‡ä»¶: `backend/app/utils/permissions.py`
```python
from functools import wraps
from fastapi import HTTPException, Request

def require_permission(permission: str):
    """æƒé™æ£€æŸ¥è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # ä»å‚æ•°ä¸­æ‰¾åˆ° Request å¯¹è±¡
            request = None
            for arg in args:
                if isinstance(arg, Request):
                    request = arg
                    break

            if not request:
                raise HTTPException(status_code=500, detail="Internal error")

            # æ£€æŸ¥æƒé™
            user_permissions = getattr(request.state, "permissions", [])
            if permission not in user_permissions:
                raise HTTPException(
                    status_code=403,
                    detail=f"æƒé™ä¸è¶³ï¼Œéœ€è¦æƒé™: {permission}"
                )

            return await func(*args, **kwargs)
        return wrapper
    return decorator

def get_current_user(request: Request) -> dict:
    """è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯"""
    return {
        "user_id": request.state.user_id,
        "username": request.state.username,
        "role_id": request.state.role_id,
        "role_name": request.state.role_name,
        "permissions": request.state.permissions
    }
```

#### Step 6: åˆ›å»º API è·¯ç”±

æ–‡ä»¶: `backend/app/api/auth.py`
```python
from fastapi import APIRouter, Depends, HTTPException, Request
from motor.motor_asyncio import AsyncIOMotorDatabase
from app.db import get_database
from app.services.auth_service import AuthService
from app.db.repositories.user_repo import UserRepository
from app.db.repositories.role_repo import RoleRepository
from pydantic import BaseModel

router = APIRouter(prefix="/api/auth", tags=["è®¤è¯"])

class LoginRequest(BaseModel):
    username: str
    password: str

class RegisterRequest(BaseModel):
    username: str
    password: str
    email: Optional[str] = None
    full_name: Optional[str] = None

@router.post("/login")
async def login(
    data: LoginRequest,
    db: AsyncIOMotorDatabase = Depends(get_database)
):
    # è®¤è¯ç”¨æˆ·
    auth_result = await AuthService.authenticate_user(db, data.username, data.password)
    if not auth_result:
        raise HTTPException(status_code=401, detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")

    user = auth_result["user"]
    role = auth_result["role"]

    # ç”Ÿæˆ Token
    token = AuthService.create_access_token(
        user_id=str(user["_id"]),
        username=user["username"],
        role_id=str(role["_id"]),
        role_name=role["name"],
        permissions=role["permissions"]
    )

    return {
        "access_token": token,
        "token_type": "Bearer",
        "user": {
            "id": str(user["_id"]),
            "username": user["username"],
            "role": {
                "name": role["name"],
                "display_name": role["display_name"],
                "permissions": role["permissions"]
            }
        }
    }

@router.post("/register")
async def register(
    data: RegisterRequest,
    db: AsyncIOMotorDatabase = Depends(get_database)
):
    user_repo = UserRepository(db)
    role_repo = RoleRepository(db)

    # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    existing = await user_repo.find_by_username(data.username)
    if existing:
        raise HTTPException(status_code=400, detail="ç”¨æˆ·åå·²å­˜åœ¨")

    # è·å–é»˜è®¤è§’è‰² (æ™®é€šç”¨æˆ·)
    default_role = await role_repo.find_by_name("user")
    if not default_role:
        raise HTTPException(status_code=500, detail="ç³»ç»Ÿé…ç½®é”™è¯¯")

    # åˆ›å»ºç”¨æˆ·
    user_data = {
        "username": data.username,
        "password": data.password,
        "email": data.email,
        "role_id": str(default_role["_id"]),
        "is_active": True,
        "is_deleted": False,
        "created_at": datetime.utcnow(),
        "updated_at": datetime.utcnow(),
        "metadata": {
            "full_name": data.full_name
        }
    }

    user_id = await user_repo.create(user_data)

    return {
        "user_id": user_id,
        "username": data.username,
        "role": default_role["name"],
        "message": "æ³¨å†ŒæˆåŠŸ"
    }

@router.get("/me")
async def get_current_user_info(request: Request):
    """è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦è®¤è¯ï¼‰"""
    from app.utils.permissions import get_current_user
    return get_current_user(request)
```

æ–‡ä»¶: `backend/app/api/users.py`
```python
from fastapi import APIRouter, Depends, HTTPException, Request
from motor.motor_asyncio import AsyncIOMotorDatabase
from app.db import get_database
from app.utils.permissions import require_permission
from app.db.repositories.user_repo import UserRepository

router = APIRouter(prefix="/api/users", tags=["ç”¨æˆ·ç®¡ç†"])

@router.get("")
@require_permission("users.view")
async def list_users(
    request: Request,
    db: AsyncIOMotorDatabase = Depends(get_database),
    page: int = 1,
    page_size: int = 20
):
    user_repo = UserRepository(db)
    total, users = await user_repo.list_with_pagination(page, page_size)

    return {
        "total": total,
        "page": page,
        "page_size": page_size,
        "users": users
    }

# ... å…¶ä»–ç”¨æˆ·ç®¡ç† API
```

æ–‡ä»¶: `backend/app/api/roles.py`
```python
from fastapi import APIRouter, Depends, HTTPException, Request
from motor.motor_asyncio import AsyncIOMotorDatabase
from app.db import get_database
from app.utils.permissions import require_permission
from app.db.repositories.role_repo import RoleRepository

router = APIRouter(prefix="/api/roles", tags=["è§’è‰²ç®¡ç†"])

@router.get("")
@require_permission("roles.view")
async def list_roles(
    request: Request,
    db: AsyncIOMotorDatabase = Depends(get_database)
):
    role_repo = RoleRepository(db)
    roles = await role_repo.list_all()
    return {"roles": roles}

# ... å…¶ä»–è§’è‰²ç®¡ç† API
```

#### Step 7: åˆå§‹åŒ–è„šæœ¬

æ–‡ä»¶: `backend/scripts/init_auth_system.py`
```python
#!/usr/bin/env python3
"""åˆå§‹åŒ–ç”¨æˆ·æƒé™ç³»ç»Ÿ"""
import asyncio
from motor.motor_asyncio import AsyncIOMotorClient
from datetime import datetime
from bson import ObjectId
import bcrypt

MONGODB_URI = "your_mongodb_uri"
DATABASE_NAME = "waveform-annotation-system"

async def init_auth_system():
    client = AsyncIOMotorClient(MONGODB_URI)
    db = client[DATABASE_NAME]

    print("ğŸš€ å¼€å§‹åˆå§‹åŒ–ç”¨æˆ·æƒé™ç³»ç»Ÿ...")

    # 1. åˆ›å»ºè§’è‰²
    print("ğŸ“ åˆ›å»ºé¢„è®¾è§’è‰²...")
    roles_collection = db["roles"]

    # åˆ é™¤ç°æœ‰è§’è‰²ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    await roles_collection.delete_many({"is_system": True})

    # æ’å…¥é¢„è®¾è§’è‰²
    admin_role_id = ObjectId()
    annotator_role_id = ObjectId()
    user_role_id = ObjectId()

    roles = [
        {
            "_id": admin_role_id,
            "name": "admin",
            "display_name": "ç®¡ç†å‘˜",
            "description": "ç³»ç»Ÿç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™",
            "permissions": [
                "users.view", "users.create", "users.update", "users.delete",
                "files.view", "files.upload", "files.delete",
                "annotations.view", "annotations.create", "annotations.update",
                "annotations.delete", "annotations.export",
                "templates.view", "templates.create", "templates.update", "templates.delete",
                "roles.view", "roles.create", "roles.update", "roles.delete",
                "system.settings", "system.logs"
            ],
            "is_system": True,
            "is_active": True,
            "created_at": datetime.utcnow(),
            "updated_at": datetime.utcnow()
        },
        {
            "_id": annotator_role_id,
            "name": "annotator",
            "display_name": "æ ‡æ³¨å‘˜",
            "description": "è´Ÿè´£æ•°æ®æ ‡æ³¨çš„ç”¨æˆ·",
            "permissions": [
                "files.view",
                "annotations.view", "annotations.create", "annotations.update",
                "templates.view"
            ],
            "is_system": True,
            "is_active": True,
            "created_at": datetime.utcnow(),
            "updated_at": datetime.utcnow()
        },
        {
            "_id": user_role_id,
            "name": "user",
            "display_name": "æ™®é€šç”¨æˆ·",
            "description": "æ™®é€šç”¨æˆ·ï¼Œåªèƒ½æŸ¥çœ‹æ•°æ®",
            "permissions": [
                "files.view",
                "annotations.view"
            ],
            "is_system": True,
            "is_active": True,
            "created_at": datetime.utcnow(),
            "updated_at": datetime.utcnow()
        }
    ]

    await roles_collection.insert_many(roles)
    print("âœ… é¢„è®¾è§’è‰²åˆ›å»ºæˆåŠŸ")

    # 2. åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
    print("ğŸ‘¤ åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·...")
    users_collection = db["users"]

    # åˆ é™¤ç°æœ‰adminç”¨æˆ·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    await users_collection.delete_one({"username": "admin"})

    # åˆ›å»ºadminè´¦æˆ·
    password_hash = bcrypt.hashpw(b"admin123", bcrypt.gensalt()).decode()

    admin_user = {
        "username": "admin",
        "email": "admin@example.com",
        "password_hash": password_hash,
        "role_id": str(admin_role_id),
        "is_active": True,
        "is_deleted": False,
        "created_at": datetime.utcnow(),
        "updated_at": datetime.utcnow(),
        "metadata": {
            "full_name": "ç³»ç»Ÿç®¡ç†å‘˜",
            "department": "ITéƒ¨é—¨"
        }
    }

    await users_collection.insert_one(admin_user)
    print("âœ… é»˜è®¤ç®¡ç†å‘˜åˆ›å»ºæˆåŠŸ")
    print("   ç”¨æˆ·å: admin")
    print("   å¯†ç : admin123")
    print("   âš ï¸  è¯·åœ¨é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹å¯†ç ï¼")

    # 3. åˆ›å»ºç´¢å¼•
    print("ğŸ” åˆ›å»ºæ•°æ®åº“ç´¢å¼•...")
    await users_collection.create_index("username", unique=True)
    await users_collection.create_index("email", unique=True, sparse=True)
    await users_collection.create_index("role_id")
    await roles_collection.create_index("name", unique=True)
    print("âœ… ç´¢å¼•åˆ›å»ºæˆåŠŸ")

    print("ğŸ‰ ç”¨æˆ·æƒé™ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼")

    client.close()

if __name__ == "__main__":
    asyncio.run(init_auth_system())
```

è¿è¡Œåˆå§‹åŒ–è„šæœ¬:
```bash
cd backend
python scripts/init_auth_system.py
```

#### Step 8: æ›´æ–° main.py

```python
# backend/app/main.py
from app.api import files, annotations, templates, auth, users, roles

# æ³¨å†Œæ–°çš„è·¯ç”±
app.include_router(auth.router)
app.include_router(users.router)
app.include_router(roles.router)
```

---

### 5.2 å‰ç«¯å®ç°æ­¥éª¤

#### Step 1: åˆ›å»ºè®¤è¯ Store

æ–‡ä»¶: `frontend/src/store/authStore.ts`
```typescript
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

interface User {
  id: string
  username: string
  role: {
    name: string
    display_name: string
    permissions: string[]
  }
}

interface AuthState {
  user: User | null
  token: string | null
  isAuthenticated: boolean

  login: (username: string, password: string) => Promise<void>
  logout: () => void
  hasPermission: (permission: string) => boolean
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      token: null,
      isAuthenticated: false,

      login: async (username, password) => {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        })

        if (!response.ok) {
          throw new Error('ç™»å½•å¤±è´¥')
        }

        const data = await response.json()

        set({
          user: data.user,
          token: data.access_token,
          isAuthenticated: true
        })
      },

      logout: () => {
        set({
          user: null,
          token: null,
          isAuthenticated: false
        })
      },

      hasPermission: (permission: string) => {
        const { user } = get()
        return user?.role.permissions.includes(permission) ?? false
      }
    }),
    {
      name: 'auth-storage'
    }
  )
)
```

#### Step 2: åˆ›å»º API å®¢æˆ·ç«¯

æ–‡ä»¶: `frontend/src/services/api.ts`
```typescript
import { useAuthStore } from '../store/authStore'

// æ·»åŠ è®¤è¯æ‹¦æˆªå™¨
export const apiClient = {
  async request(url: string, options: RequestInit = {}) {
    const token = useAuthStore.getState().token

    const headers = {
      'Content-Type': 'application/json',
      ...(token && { 'Authorization': `Bearer ${token}` }),
      ...options.headers
    }

    const response = await fetch(url, {
      ...options,
      headers
    })

    // å¤„ç† 401 æœªæˆæƒ
    if (response.status === 401) {
      useAuthStore.getState().logout()
      window.location.href = '/login'
    }

    return response
  }
}
```

#### Step 3: åˆ›å»ºç™»å½•é¡µé¢

æ–‡ä»¶: `frontend/src/pages/LoginPage.tsx`
```typescript
import { useState } from 'react'
import { useNavigate } from 'react-router-dom'
import { useAuthStore } from '../store/authStore'

export default function LoginPage() {
  const [username, setUsername] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)

  const { login } = useAuthStore()
  const navigate = useNavigate()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')
    setLoading(true)

    try {
      await login(username, password)
      navigate('/')
    } catch (err) {
      setError('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
        <h1 className="text-2xl font-bold text-center mb-6">
          æ³¢å½¢æ ‡æ³¨ç³»ç»Ÿ
        </h1>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              ç”¨æˆ·å
            </label>
            <input
              type="text"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              å¯†ç 
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md"
              required
            />
          </div>

          {error && (
            <div className="text-sm text-red-600">{error}</div>
          )}

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 disabled:opacity-50"
          >
            {loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
          </button>
        </form>
      </div>
    </div>
  )
}
```

#### Step 4: åˆ›å»ºæƒé™ç»„ä»¶

æ–‡ä»¶: `frontend/src/components/PermissionGate.tsx`
```typescript
import { useAuthStore } from '../store/authStore'

interface PermissionGateProps {
  permission: string
  fallback?: React.ReactNode
  children: React.ReactNode
}

export function PermissionGate({ permission, fallback = null, children }: PermissionGateProps) {
  const hasPermission = useAuthStore((state) => state.hasPermission(permission))

  if (!hasPermission) {
    return <>{fallback}</>
  }

  return <>{children}</>
}
```

#### Step 5: åˆ›å»ºè·¯ç”±å®ˆå«

æ–‡ä»¶: `frontend/src/App.tsx`
```typescript
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom'
import { useAuthStore } from './store/authStore'
import LoginPage from './pages/LoginPage'
import WorkspacePage from './pages/WorkspacePage'

function ProtectedRoute({ children }: { children: React.ReactNode }) {
  const isAuthenticated = useAuthStore((state) => state.isAuthenticated)

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />
  }

  return <>{children}</>
}

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/login" element={<LoginPage />} />
        <Route
          path="/"
          element={
            <ProtectedRoute>
              <WorkspacePage />
            </ProtectedRoute>
          }
        />
      </Routes>
    </BrowserRouter>
  )
}

export default App
```

---

## 6. é…ç½®ç¤ºä¾‹

### 6.1 ç¯å¢ƒå˜é‡é…ç½®

æ–‡ä»¶: `backend/.env`
```env
# MongoDB
MONGODB_URI=mongodb://username:password@host:port/
MONGODB_DATABASE=waveform-annotation-system

# JWT
JWT_SECRET_KEY=your-very-secure-secret-key-change-in-production
JWT_ALGORITHM=HS256
JWT_EXPIRATION_DAYS=7

# å…¶ä»–é…ç½®
H5_DATA_PATH=../dataset
CORS_ORIGINS=["http://localhost:5173"]
```

### 6.2 æƒé™é…ç½®æ–‡ä»¶

æ–‡ä»¶: `backend/app/config/permissions.py`
```python
# æ‰€æœ‰å¯ç”¨æƒé™å®šä¹‰
ALL_PERMISSIONS = {
    "users.view": {"description": "æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨", "category": "ç”¨æˆ·ç®¡ç†"},
    "users.create": {"description": "åˆ›å»ºç”¨æˆ·", "category": "ç”¨æˆ·ç®¡ç†"},
    "users.update": {"description": "æ›´æ–°ç”¨æˆ·", "category": "ç”¨æˆ·ç®¡ç†"},
    "users.delete": {"description": "åˆ é™¤ç”¨æˆ·", "category": "ç”¨æˆ·ç®¡ç†"},

    "files.view": {"description": "æŸ¥çœ‹æ–‡ä»¶", "category": "æ–‡ä»¶ç®¡ç†"},
    "files.upload": {"description": "ä¸Šä¼ æ–‡ä»¶", "category": "æ–‡ä»¶ç®¡ç†"},
    "files.delete": {"description": "åˆ é™¤æ–‡ä»¶", "category": "æ–‡ä»¶ç®¡ç†"},

    "annotations.view": {"description": "æŸ¥çœ‹æ ‡æ³¨", "category": "æ ‡æ³¨ç®¡ç†"},
    "annotations.create": {"description": "åˆ›å»ºæ ‡æ³¨", "category": "æ ‡æ³¨ç®¡ç†"},
    "annotations.update": {"description": "æ›´æ–°æ ‡æ³¨", "category": "æ ‡æ³¨ç®¡ç†"},
    "annotations.delete": {"description": "åˆ é™¤æ ‡æ³¨", "category": "æ ‡æ³¨ç®¡ç†"},
    "annotations.export": {"description": "å¯¼å‡ºæ ‡æ³¨", "category": "æ ‡æ³¨ç®¡ç†"},

    "templates.view": {"description": "æŸ¥çœ‹æ¨¡æ¿", "category": "æ¨¡æ¿ç®¡ç†"},
    "templates.create": {"description": "åˆ›å»ºæ¨¡æ¿", "category": "æ¨¡æ¿ç®¡ç†"},
    "templates.update": {"description": "æ›´æ–°æ¨¡æ¿", "category": "æ¨¡æ¿ç®¡ç†"},
    "templates.delete": {"description": "åˆ é™¤æ¨¡æ¿", "category": "æ¨¡æ¿ç®¡ç†"},

    "roles.view": {"description": "æŸ¥çœ‹è§’è‰²", "category": "è§’è‰²ç®¡ç†"},
    "roles.create": {"description": "åˆ›å»ºè§’è‰²", "category": "è§’è‰²ç®¡ç†"},
    "roles.update": {"description": "æ›´æ–°è§’è‰²", "category": "è§’è‰²ç®¡ç†"},
    "roles.delete": {"description": "åˆ é™¤è§’è‰²", "category": "è§’è‰²ç®¡ç†"},

    "system.settings": {"description": "ç³»ç»Ÿè®¾ç½®", "category": "ç³»ç»Ÿç®¡ç†"},
    "system.logs": {"description": "ç³»ç»Ÿæ—¥å¿—", "category": "ç³»ç»Ÿç®¡ç†"}
}

# é¢„è®¾è§’è‰²æƒé™é…ç½®
ROLE_PRESETS = {
    "admin": list(ALL_PERMISSIONS.keys()),  # æ‰€æœ‰æƒé™
    "annotator": [
        "files.view",
        "annotations.view", "annotations.create", "annotations.update",
        "templates.view"
    ],
    "user": [
        "files.view",
        "annotations.view"
    ]
}
```

---

## 7. å®‰å…¨å»ºè®®

### 7.1 å¯†ç å®‰å…¨
- ä½¿ç”¨ bcrypt åŠ å¯†å¯†ç ï¼ˆå·²åŒ…å«ï¼‰
- å¼ºåˆ¶å¯†ç å¤æ‚åº¦è¦æ±‚ï¼ˆå»ºè®®å®ç°ï¼‰
- é¦–æ¬¡ç™»å½•å¼ºåˆ¶ä¿®æ”¹é»˜è®¤å¯†ç ï¼ˆå»ºè®®å®ç°ï¼‰
- å¯†ç é‡è¯•æ¬¡æ•°é™åˆ¶ï¼ˆå»ºè®®å®ç°ï¼‰

### 7.2 Token å®‰å…¨
- JWT Secret Key å¿…é¡»ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²
- Token æœ‰æ•ˆæœŸä¸å®œè¿‡é•¿ï¼ˆå½“å‰ 7 å¤©ï¼Œå¯è°ƒæ•´ï¼‰
- è€ƒè™‘å®ç° Refresh Token æœºåˆ¶
- æ•æ„Ÿæ“ä½œéœ€è¦é‡æ–°éªŒè¯

### 7.3 API å®‰å…¨
- æ‰€æœ‰ API é»˜è®¤éœ€è¦è®¤è¯
- æƒé™æ£€æŸ¥åœ¨æ¯ä¸ªæ“ä½œå‰æ‰§è¡Œ
- è¾“å…¥éªŒè¯å’Œå‚æ•°æ ¡éªŒ
- é˜²æ­¢ SQL æ³¨å…¥å’Œ XSS æ”»å‡»

### 7.4 æ•°æ®å®‰å…¨
- ç”¨æˆ·å¯†ç ä¸å¯æ˜æ–‡å­˜å‚¨
- æ•æ„Ÿä¿¡æ¯åŠ å¯†ä¼ è¾“ï¼ˆHTTPSï¼‰
- å®šæœŸå¤‡ä»½æ•°æ®åº“
- å®¡è®¡æ—¥å¿—è®°å½•ï¼ˆå»ºè®®å®ç°ï¼‰

---

## 8. æµ‹è¯•å»ºè®®

### 8.1 å•å…ƒæµ‹è¯•
```python
# tests/test_auth_service.py
import pytest
from app.services.auth_service import AuthService

def test_create_access_token():
    token = AuthService.create_access_token(
        user_id="123",
        username="test",
        role_id="456",
        role_name="admin",
        permissions=["users.view"]
    )
    assert token is not None

def test_verify_token():
    token = AuthService.create_access_token(...)
    payload = AuthService.verify_token(token)
    assert payload["username"] == "test"
```

### 8.2 é›†æˆæµ‹è¯•
```python
# tests/test_auth_api.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_login_success():
    response = client.post("/api/auth/login", json={
        "username": "admin",
        "password": "admin123"
    })
    assert response.status_code == 200
    assert "access_token" in response.json()

def test_login_failure():
    response = client.post("/api/auth/login", json={
        "username": "admin",
        "password": "wrong_password"
    })
    assert response.status_code == 401
```

---

## 9. ç»´æŠ¤å’Œæ‰©å±•

### 9.1 æ·»åŠ æ–°æƒé™
1. åœ¨ `permissions.py` çš„ `ALL_PERMISSIONS` ä¸­æ·»åŠ æ–°æƒé™
2. æ›´æ–°ç›¸å…³è§’è‰²çš„æƒé™åˆ—è¡¨
3. åœ¨ API ä¸­ä½¿ç”¨ `@require_permission("new.permission")` ä¿æŠ¤ç«¯ç‚¹

### 9.2 åˆ›å»ºè‡ªå®šä¹‰è§’è‰²
1. ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•
2. è°ƒç”¨ `POST /api/roles` åˆ›å»ºæ–°è§’è‰²
3. ä» `ALL_PERMISSIONS` ä¸­é€‰æ‹©éœ€è¦çš„æƒé™
4. å°†ç”¨æˆ·åˆ†é…åˆ°æ–°è§’è‰²

### 9.3 æ•°æ®è¿ç§»
- ä½¿ç”¨ MongoDB çš„å¤‡ä»½æ¢å¤åŠŸèƒ½
- æ³¨æ„ä¿æŒ users å’Œ roles çš„å…³è”å…³ç³»
- è¿ç§»å‰éªŒè¯ç´¢å¼•å®Œæ•´æ€§

---

## 10. å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•é‡ç½®ç®¡ç†å‘˜å¯†ç ï¼Ÿ
```python
# åœ¨ MongoDB shell ä¸­æ‰§è¡Œ
import bcrypt
new_password_hash = bcrypt.hashpw(b"new_password", bcrypt.gensalt()).decode()
db.users.update_one(
    {"username": "admin"},
    {"$set": {"password_hash": new_password_hash}}
)
```

### Q2: å¦‚ä½•ç»™ç°æœ‰ç”¨æˆ·åˆ†é…æƒé™ï¼Ÿ
é€šè¿‡ä¿®æ”¹ç”¨æˆ·çš„ `role_id`ï¼Œæˆ–è€…åˆ›å»º/ä¿®æ”¹è§’è‰²çš„æƒé™åˆ—è¡¨

### Q3: Token è¿‡æœŸåæ€ä¹ˆåŠï¼Ÿ
éœ€è¦é‡æ–°ç™»å½•è·å–æ–° Tokenï¼Œæˆ–å®ç° Refresh Token æœºåˆ¶

### Q4: å¦‚ä½•æŸ¥çœ‹å½“å‰æ‰€æœ‰æƒé™ï¼Ÿ
è°ƒç”¨ `GET /api/permissions` APIï¼ˆéœ€è¦ `roles.view` æƒé™ï¼‰

---

## 11. ä¸‹ä¸€æ­¥æ”¹è¿›å»ºè®®

1. **å®ç° Refresh Token æœºåˆ¶** - æå‡ç”¨æˆ·ä½“éªŒ
2. **æ·»åŠ å®¡è®¡æ—¥å¿—** - è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ
3. **å¯†ç ç­–ç•¥é…ç½®** - å¼ºåˆ¶å¯†ç å¤æ‚åº¦å’Œå®šæœŸæ›´æ¢
4. **å¤šå› ç´ è®¤è¯ (MFA)** - æå‡å®‰å…¨æ€§
5. **OAuth2 é›†æˆ** - æ”¯æŒç¬¬ä¸‰æ–¹ç™»å½•
6. **ä¼šè¯ç®¡ç†** - æ”¯æŒè¸¢å‡ºåœ¨çº¿ç”¨æˆ·
7. **æƒé™ç»§æ‰¿** - æ”¯æŒè§’è‰²ç»§æ‰¿æœºåˆ¶
8. **å‰ç«¯æƒé™UI** - å¯è§†åŒ–æƒé™é…ç½®ç•Œé¢

---

## 12. æ€»ç»“

æœ¬è®¾è®¡æ–‡æ¡£æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·æƒé™ç³»ç»Ÿå®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

âœ… **æ•°æ®åº“è®¾è®¡** - MongoDB schema å’Œç´¢å¼•
âœ… **API è®¾è®¡** - RESTful API è§„èŒƒ
âœ… **è®¤è¯æˆæƒ** - JWT + RBAC æƒé™æ§åˆ¶
âœ… **é»˜è®¤é…ç½®** - ä¸‰ä¸ªé¢„è®¾è§’è‰²å’Œç®¡ç†å‘˜è´¦æˆ·
âœ… **å®ç°æŒ‡å—** - å®Œæ•´çš„ä»£ç ç¤ºä¾‹
âœ… **å®‰å…¨å»ºè®®** - å®‰å…¨æœ€ä½³å®è·µ
âœ… **æµ‹è¯•å»ºè®®** - å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

æŒ‰ç…§æœ¬æ–‡æ¡£çš„æ­¥éª¤å®æ–½ï¼Œå¯ä»¥å¿«é€Ÿæ­å»ºä¸€ä¸ªå®‰å…¨ã€å¯æ‰©å±•çš„ç”¨æˆ·æƒé™ç³»ç»Ÿã€‚
