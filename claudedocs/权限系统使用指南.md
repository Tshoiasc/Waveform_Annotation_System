# 用户权限系统使用指南

## ✅ 系统已实现

基于设计文档的完整用户权限系统已成功实现，包括：

- ✅ **后端** (FastAPI + MongoDB + JWT)
  - 用户和角色数据模型
  - Repository 数据访问层
  - JWT 认证服务
  - 权限中间件和装饰器
  - 认证、用户、角色 API 路由
  - 数据库初始化脚本

- ✅ **前端** (React + TypeScript + Zustand)
  - 认证状态管理 (Zustand)
  - API 客户端（自动 JWT 认证）
  - 登录页面
  - 权限门控组件
  - 路由守卫

## 🚀 快速启动

### 1. 初始化数据库

确保 MongoDB 已启动，然后运行初始化脚本：

```bash
cd backend
python scripts/init_auth_system.py
```

**输出示例：**
```
🚀 开始初始化用户权限系统...
📝 创建预设角色...
✅ 预设角色创建成功
👤 创建默认管理员账户...
✅ 默认管理员创建成功
   用户名: admin
   密码: admin123
   ⚠️  请在首次登录后立即修改密码！
🔍 创建数据库索引...
✅ 索引创建成功
🎉 用户权限系统初始化完成！
```

### 2. 配置环境变量

复制 `.env.example` 并根据需要修改：

```bash
cd backend
cp .env.example .env
```

**重要配置项：**
- `JWT_SECRET_KEY`: 生产环境必须更换为强随机字符串
- `MONGODB_URI`: MongoDB 连接地址
- `JWT_EXPIRATION_DAYS`: Token 有效期（默认 7 天）

### 3. 启动后端

```bash
cd backend
uvicorn app.main:app --reload
```

访问 http://localhost:8000/docs 查看 API 文档

### 4. 启动前端

```bash
cd frontend
npm install  # 首次运行需要安装依赖
npm run dev
```

访问 http://localhost:5173

## 🔐 默认账户

| 角色 | 用户名 | 密码 | 权限 |
|------|--------|------|------|
| 管理员 | admin | admin123 | 所有权限 |

**⚠️ 安全提示：首次登录后请立即修改默认密码！**

## 👥 预设角色和权限

### 1. 管理员 (admin)
**所有权限**，包括：
- 用户管理：查看、创建、更新、删除用户
- 文件管理：查看、上传、删除文件
- 标注管理：查看、创建、更新、删除、导出标注
- 模板管理：查看、创建、更新、删除模板
- 角色管理：查看、创建、更新、删除角色
- 系统管理：系统设置、查看日志

### 2. 标注员 (annotator)
**标注工作权限**：
- 文件管理：查看文件
- 标注管理：查看、创建、更新标注
- 模板管理：查看模板

### 3. 普通用户 (user)
**只读权限**：
- 文件管理：查看文件
- 标注管理：查看标注

## 📚 API 使用示例

### 用户登录

```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}'
```

**响应：**
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "Bearer",
  "user": {
    "id": "...",
    "username": "admin",
    "role": {
      "name": "admin",
      "display_name": "管理员",
      "permissions": ["users.view", "users.create", ...]
    }
  }
}
```

### 创建用户

```bash
curl -X POST http://localhost:8000/api/users \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "annotator1",
    "email": "annotator1@example.com",
    "password": "password123",
    "role_id": "ANNOTATOR_ROLE_ID",
    "metadata": {
      "full_name": "张三",
      "department": "标注部"
    }
  }'
```

### 获取所有角色

```bash
curl -X GET http://localhost:8000/api/roles \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 🎯 前端使用示例

### 在组件中检查权限

```tsx
import { PermissionGate } from '@/components/PermissionGate';

function MyComponent() {
  return (
    <div>
      {/* 只有拥有 users.create 权限的用户才能看到此按钮 */}
      <PermissionGate permission="users.create">
        <button>创建用户</button>
      </PermissionGate>

      {/* 没有权限时显示 fallback */}
      <PermissionGate
        permission="users.delete"
        fallback={<p>您没有删除权限</p>}
      >
        <button>删除用户</button>
      </PermissionGate>
    </div>
  );
}
```

### 在代码中检查权限

```tsx
import { useAuthStore } from '@/store/authStore';

function MyComponent() {
  const hasPermission = useAuthStore((state) =>
    state.hasPermission('users.create')
  );

  const handleCreate = () => {
    if (!hasPermission) {
      alert('权限不足');
      return;
    }
    // 执行创建操作
  };

  return <button onClick={handleCreate}>创建</button>;
}
```

### 获取当前用户信息

```tsx
import { useAuthStore } from '@/store/authStore';

function UserProfile() {
  const user = useAuthStore((state) => state.user);

  return (
    <div>
      <p>用户名: {user?.username}</p>
      <p>角色: {user?.role.display_name}</p>
      <p>权限数量: {user?.role.permissions.length}</p>
    </div>
  );
}
```

## 🔧 管理操作

### 修改密码

```bash
curl -X PUT http://localhost:8000/api/auth/change-password \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "old_password": "admin123",
    "new_password": "NewSecurePassword123!"
  }'
```

### 创建自定义角色

```bash
curl -X POST http://localhost:8000/api/roles \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "reviewer",
    "display_name": "审核员",
    "description": "负责审核标注结果",
    "permissions": [
      "files.view",
      "annotations.view",
      "annotations.update",
      "templates.view"
    ]
  }'
```

### 更新用户角色

```bash
curl -X PUT http://localhost:8000/api/users/USER_ID \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "role_id": "NEW_ROLE_ID"
  }'
```

## 🛡️ 安全建议

### 生产环境配置

1. **更换 JWT Secret Key**
   ```env
   JWT_SECRET_KEY=use-a-strong-random-string-at-least-32-chars
   ```

2. **使用 HTTPS**
   ```
   所有生产环境必须启用 HTTPS
   ```

3. **修改默认管理员密码**
   ```
   首次登录后立即修改 admin 账户密码
   ```

4. **设置合理的 Token 过期时间**
   ```env
   JWT_EXPIRATION_DAYS=7  # 根据安全需求调整
   ```

### 权限最佳实践

- **最小权限原则**：只分配必需的权限
- **定期审计**：定期检查用户权限是否合理
- **角色分离**：使用预设角色，避免直接修改系统角色权限
- **操作日志**：记录敏感操作（未来可扩展）

## 📊 权限系统架构

```
┌─────────────────────────────────────────────────────┐
│                    前端应用                          │
│  ┌──────────────┐  ┌──────────────┐                │
│  │  登录页面    │  │  权限门控    │                │
│  └──────────────┘  └──────────────┘                │
│         │                  │                        │
│         ▼                  ▼                        │
│  ┌─────────────────────────────┐                   │
│  │   Zustand Auth Store        │                   │
│  │  - user, token, permissions │                   │
│  └─────────────────────────────┘                   │
│         │                                           │
│         ▼                                           │
│  ┌─────────────────────────────┐                   │
│  │   API Client (Fetch)        │                   │
│  │  - Auto JWT Authorization   │                   │
│  └─────────────────────────────┘                   │
└─────────────────────────────────────────────────────┘
                    │
                    │ HTTP + JWT
                    ▼
┌─────────────────────────────────────────────────────┐
│                  FastAPI 后端                        │
│  ┌─────────────────────────────┐                   │
│  │   AuthMiddleware            │                   │
│  │  - JWT 验证                 │                   │
│  │  - 注入用户信息到 request   │                   │
│  └─────────────────────────────┘                   │
│         │                                           │
│         ▼                                           │
│  ┌─────────────────────────────┐                   │
│  │   API Routes                │                   │
│  │  - @require_permission      │                   │
│  │  - 权限检查装饰器            │                   │
│  └─────────────────────────────┘                   │
│         │                                           │
│         ▼                                           │
│  ┌─────────────────────────────┐                   │
│  │   Repositories              │                   │
│  │  - UserRepo, RoleRepo       │                   │
│  └─────────────────────────────┘                   │
└─────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────┐
│               MongoDB 数据库                         │
│  ┌──────────┐  ┌──────────┐                        │
│  │  users   │  │  roles   │                        │
│  └──────────┘  └──────────┘                        │
└─────────────────────────────────────────────────────┘
```

## ❓ 常见问题

### Q1: 如何重置管理员密码？

在 MongoDB shell 或数据库工具中执行：
```javascript
db.users.updateOne(
  { username: "admin" },
  { $set: {
    password_hash: "$2b$12$NEW_HASH_HERE"
  }}
)
```

或使用 Python bcrypt：
```python
import bcrypt
new_hash = bcrypt.hashpw(b"new_password", bcrypt.gensalt()).decode()
```

### Q2: Token 过期后怎么办？

Token 过期后，前端会自动跳转到登录页面。用户需要重新登录获取新 Token。

### Q3: 如何添加新的权限？

1. 在 `backend/app/config/permissions.py` 的 `ALL_PERMISSIONS` 中添加新权限
2. 在需要的 API 路由上使用 `@require_permission("new.permission")`
3. 将权限分配给相应的角色

### Q4: 能否实现 Refresh Token？

当前版本未实现 Refresh Token。可以通过以下方式扩展：
1. 在登录时返回 access_token 和 refresh_token
2. access_token 设置较短过期时间（如 15 分钟）
3. refresh_token 设置较长过期时间（如 7 天）
4. 实现 `/api/auth/refresh` 端点用 refresh_token 换取新 access_token

### Q5: 如何禁用某个用户？

```bash
curl -X PUT http://localhost:8000/api/users/USER_ID \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"is_active": false}'
```

## 🎉 总结

用户权限系统已完全实现并可用。您可以：

1. ✅ 使用默认管理员账户登录
2. ✅ 创建新用户并分配角色
3. ✅ 自定义角色和权限
4. ✅ 在前端使用权限门控保护功能
5. ✅ 在后端使用装饰器保护 API 路由

如有任何问题，请参考[完整设计文档](./用户权限系统设计文档.md)。
