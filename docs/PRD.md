# æ³¢å½¢æ ‡æ³¨ç³»ç»Ÿ - äº§å“éœ€æ±‚æ–‡æ¡£ (PRD)

**é¡¹ç›®åç§°**: Web-Based Waveform Annotation System
**ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-10-01
**çŠ¶æ€**: éœ€æ±‚å·²ç¡®è®¤ï¼Œå¾…å¼€å‘

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯
å½“å‰ä½¿ç”¨Pythonè„šæœ¬ `annotate_h5_waveform.py` è¿›è¡Œæ³¢å½¢æ ‡æ³¨ï¼Œå­˜åœ¨ä»¥ä¸‹ç—›ç‚¹ï¼š
- å•æœºè¿è¡Œï¼Œæ— æ³•æ”¯æŒå›¢é˜Ÿåä½œ
- æ ‡æ³¨æ•°æ®åˆ†æ•£åœ¨æœ¬åœ°æ–‡ä»¶ï¼Œéš¾ä»¥é›†ä¸­ç®¡ç†
- ç¼ºä¹æ ‡æ³¨è¿›åº¦å¯è§†åŒ–å’Œè´¨é‡æ§åˆ¶æœºåˆ¶

### 1.2 äº§å“ç›®æ ‡
æ„å»ºä¸€ä¸ª**ä¸“ä¸šã€ç¾è§‚ã€äº¤äº’æ„Ÿå¼º**çš„Webæ³¢å½¢æ ‡æ³¨ç³»ç»Ÿï¼Œæ”¯æŒï¼š
- äº‘ç«¯å¤šç”¨æˆ·åä½œæ ‡æ³¨
- é›†ä¸­åŒ–æ•°æ®ç®¡ç†ä¸è¿›åº¦è¿½è¸ª
- çµæ´»çš„äº‹ä»¶åºåˆ—é…ç½®
- é«˜æ•ˆçš„æ³¢å½¢æµè§ˆä¸ç¼©æ”¾äº¤äº’

### 1.3 æ ¸å¿ƒä»·å€¼
- **æ•ˆç‡æå‡**: å›¢é˜Ÿåä½œ + å¿«æ·é”®æ“ä½œï¼Œæ ‡æ³¨æ•ˆç‡æå‡50%+
- **æ•°æ®å®‰å…¨**: é›†ä¸­åŒ–MongoDBå­˜å‚¨ï¼Œæ ‡æ³¨ç»“æœå®æ—¶ä¿å­˜
- **è´¨é‡ä¿éšœ**: è¿›åº¦å¯è§†åŒ– + æ‚²è§‚é”æœºåˆ¶ï¼Œé¿å…é‡å¤åŠ³åŠ¨å’Œæ•°æ®å†²çª

---

## 2. ç”¨æˆ·è§’è‰²ä¸æƒé™

| è§’è‰² | æƒé™ | å…¸å‹åœºæ™¯ |
|------|------|----------|
| **ç®¡ç†å‘˜ (Admin)** | åˆ›å»ºå…¨å±€äº‹ä»¶æ¨¡æ¿ã€ç®¡ç†ç”¨æˆ· | å®éªŒå®¤è´Ÿè´£äºº |
| **æ ‡æ³¨å‘˜ (Annotator)** | æ ‡æ³¨æ³¢å½¢ã€åˆ›å»ºç§æœ‰æ¨¡æ¿ | ç ”ç©¶ç”Ÿã€åŠ©ç† |
| **æŸ¥çœ‹è€… (Viewer)** | ä»…æŸ¥çœ‹æ ‡æ³¨ç»“æœ | åˆä½œè€…ã€å®¡æ ¸äººå‘˜ |

---

## 3. åŠŸèƒ½éœ€æ±‚

### 3.1 ä¸‰æ å¼å¸ƒå±€ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯¼èˆªæ : Logo | ç”¨æˆ·ä¿¡æ¯ | äº‹ä»¶åºåˆ—é…ç½®å…¥å£                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ä¸€åˆ—   â”‚  ç¬¬äºŒåˆ—   â”‚           å·¥ä½œåŒº (Workspace)               â”‚
â”‚  æ–‡ä»¶åˆ—è¡¨ â”‚ Trialåˆ—è¡¨ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚           â”‚           â”‚  â”‚ æ¨ªå‘åˆ»åº¦æ¡ (Timeline Ruler)        â”‚   â”‚
â”‚  ğŸ“ exp01 â”‚ â–¶ Trial 1 â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  ğŸ“ exp02 â”‚   Trial 2 â”‚  â”‚ æ³¢å½¢å›¾ (uPlot)                     â”‚   â”‚
â”‚  ğŸ“ exp03 â”‚   Trial 3 â”‚  â”‚ - åŸå§‹æ³¢å½¢ (ç°è‰²åŠé€æ˜)             â”‚   â”‚
â”‚           â”‚   ...     â”‚  â”‚ - æ»¤æ³¢æ³¢å½¢ (ä¸»è‰²)                  â”‚   â”‚
â”‚  è¿›åº¦:    â”‚           â”‚  â”‚ - å­äº‹ä»¶è¾¹ç•Œç‚¹ (å½©è‰²å‚ç›´çº¿)         â”‚   â”‚
â”‚  â–“â–“â–“â–“â–‘ 60% â”‚ ç¼©ç•¥å›¾   â”‚  â”‚ - å½©è‰²Mask (å·²æ ‡æ³¨åŒºåŸŸ)            â”‚   â”‚
â”‚           â”‚  âš¡âš¡âš¡   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚  è¿›åº¦:    â”‚                                            â”‚
â”‚           â”‚  â–“â–“â–‘ 40%  â”‚  å¿«æ·é”®æç¤º: [1] Baseline [2] Approach... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3.2 æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### ğŸ“‚ **Module 1: æ–‡ä»¶ä¸Trialç®¡ç†** (ä¼˜å…ˆçº§P0)

**3.2.1 æ–‡ä»¶åˆ—è¡¨ (ç¬¬ä¸€åˆ—)**
- **æ•°æ®æº**: `dataset/` ç›®å½•ä¸‹çš„H5æ–‡ä»¶
- **æ˜¾ç¤ºå†…å®¹**:
  - æ–‡ä»¶å¤¹/æ–‡ä»¶æ ‘å½¢ç»“æ„
  - æ ‡æ³¨è¿›åº¦æ¡ + ç™¾åˆ†æ¯” (å¦‚: `â–“â–“â–“â–“â–‘ 60%`)
  - å½©è‰²æ ‡ç­¾:
    - ğŸŸ¢ å·²å®Œæˆ (100%)
    - ğŸŸ¡ è¿›è¡Œä¸­ (1%-99%)
    - âšª æœªå¼€å§‹ (0%)
  - å·²æ ‡æ³¨äº‹ä»¶æ•°é‡ (å¦‚: `12/20 events`)
- **äº¤äº’**:
  - ç‚¹å‡»æ–‡ä»¶ â†’ åŠ è½½æ‰€æœ‰Trialsåˆ°ç¬¬äºŒåˆ—
  - æ”¯æŒæœç´¢/ç­›é€‰ (æŒ‰æ–‡ä»¶åã€æ ‡æ³¨çŠ¶æ€)

**3.2.2 Trialåˆ—è¡¨ (ç¬¬äºŒåˆ—)**
- **æ˜¾ç¤ºå†…å®¹**:
  - Trialç¼–å· + ç¼©ç•¥å›¾ (é™é‡‡æ ·åˆ°100ç‚¹)
  - ç¼©ç•¥å›¾å åŠ å±‚:
    - æ³¢å½¢è½®å»“ (ç°è‰²)
    - æ ‡æ³¨è¿›åº¦æ¡ (å½©è‰²æ¨ªæ¡ï¼Œä½†ä¸æ˜¾ç¤ºå…·ä½“é˜¶æ®µç»†èŠ‚)
  - æ ‡æ³¨è¿›åº¦: `â–“â–“â–‘ 40%`
- **äº¤äº’**:
  - ç‚¹å‡»Trial â†’ åŠ è½½å®Œæ•´æ³¢å½¢åˆ°å·¥ä½œåŒº
  - åŒå‡» â†’ å¿«é€Ÿè·³è½¬åˆ°ç¬¬ä¸€ä¸ªæœªæ ‡æ³¨äº‹ä»¶
  - å³é”®èœå•: æ ‡è®°ä¸ºå·²å®Œæˆ/é‡ç½®æ ‡æ³¨

**æ•°æ®æµ**:
```mermaid
graph LR
    A[ç‚¹å‡»æ–‡ä»¶] --> B[GET /api/files/{file_id}/trials]
    B --> C[è¿”å›æ‰€æœ‰Trialså…ƒæ•°æ® + ç¼©ç•¥å›¾]
    C --> D[æ¸²æŸ“Trialåˆ—è¡¨]
    E[ç‚¹å‡»Trial] --> F[GET /api/files/{file_id}/trials/{trial_id}/waveform]
    F --> G[è¿”å›é¢„å¤„ç†åçš„å®Œæ•´æ³¢å½¢]
    G --> H[æ¸²æŸ“å·¥ä½œåŒºæ³¢å½¢å›¾]
```

---

#### ğŸ¨ **Module 2: æ³¢å½¢å¯è§†åŒ–ä¸äº¤äº’** (ä¼˜å…ˆçº§P0)

**3.2.3 æ¨ªå‘åˆ»åº¦æ¡ (Timeline Ruler)**
- **ä½ç½®**: æ³¢å½¢å›¾ä¸Šæ–¹
- **æ˜¾ç¤ºå†…å®¹**:
  - æ—¶é—´åˆ»åº¦ (å•ä½: ç§’)
  - å­äº‹ä»¶è¾¹ç•Œç‚¹ (å½©è‰²åœ†ç‚¹)
    - Baseline: ğŸ”µ è“è‰²
    - Approach: ğŸŸ¢ ç»¿è‰²
    - Impact: ğŸ”´ çº¢è‰²
    - Ringdown: ğŸŸ£ ç´«è‰²
- **äº¤äº’**:
  - ç‚¹å‡»åˆ»åº¦æ¡ â†’ æ³¢å½¢å›¾è·³è½¬åˆ°å¯¹åº”æ—¶é—´
  - é¼ æ ‡æ‚¬åœ â†’ æ˜¾ç¤ºç²¾ç¡®æ—¶é—´æˆ³

**3.2.4 æ³¢å½¢å›¾ (åŸºäº uPlot)**
- **å›¾å±‚å åŠ ** (ä»åº•åˆ°é¡¶):
  1. å½©è‰²Maskå±‚ (å·²æ ‡æ³¨åŒºåŸŸï¼Œopacity: 0.25)
  2. åŸå§‹æ³¢å½¢ (ç°è‰²ï¼Œopacity: 0.3)
  3. æ»¤æ³¢æ³¢å½¢ (ä¸»è‰²ï¼ŒlineWidth: 2)
  4. å­äº‹ä»¶è¾¹ç•Œç‚¹ (å½©è‰²å‚ç›´çº¿ + åœ†ç‚¹)
  5. åå­—å‡†æ˜Ÿ (é¼ æ ‡è·Ÿéš)

- **ç¼©æ”¾äº¤äº’**:
  - æ»šè½®: ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾Xè½´
  - Shift + æ»šè½®: ä»…ç¼©æ”¾Yè½´
  - Cmd/Ctrl + æ»šè½®: ä»…ç¼©æ”¾Xè½´
  - åŒæŒ‡è§¦æ§æ¿: æ”¯æŒå¤šç‚¹è§¦æ§ç¼©æ”¾

- **ç¼©æ”¾å†å²è®°å½•**:
  - æ•°æ®ç»“æ„: `Stack<{xMin, xMax, yMin, yMax}>`
  - å¿«æ·é”®:
    - `Ctrl+Z`: å›é€€è§†å›¾
    - `Ctrl+Shift+Z`: å‰è¿›è§†å›¾
  - UI: å·¦ä¸Šè§’é¢åŒ…å±‘ (å¦‚: `ä¸»è§†å›¾ > 5-10s > 7-8s`)

**3.2.5 æ ‡æ³¨æ“ä½œ**
- **å½“å‰é˜¶æ®µæ¨¡å¼**: é¡¶éƒ¨æ˜¾ç¤ºå½“å‰æ¿€æ´»é˜¶æ®µ (å¦‚: `ğŸ”µ Baselineæ¨¡å¼`)
- **å¿«æ·é”®åˆ‡æ¢**:
  - `1-9`: åˆ‡æ¢é˜¶æ®µæ¨¡å¼ (Baseline=1, Approach=2...)
  - `Esc`: å–æ¶ˆæ ‡æ³¨æ¨¡å¼
- **ç‚¹å‡»æ ‡æ³¨**:
  - ç‚¹å‡»æ³¢å½¢å›¾ â†’ åœ¨å½“å‰æ¿€æ´»é˜¶æ®µæ¨¡å¼ä¸‹æ·»åŠ æ ‡æ³¨ç‚¹
  - æ˜¾ç¤ºå®æ—¶åé¦ˆ: é—ªçƒåŠ¨ç”» + éŸ³æ•ˆæç¤º
- **åˆ é™¤æ ‡æ³¨**:
  - å³é”®ç‚¹å‡»è¾¹ç•Œç‚¹ â†’ åˆ é™¤è¯¥æ ‡æ³¨
  - å¿«æ·é”®: `D` (Deleteæœ€è¿‘æ ‡æ³¨ç‚¹)

**3.2.6 äº‹ä»¶èŒƒå›´è‡ªåŠ¨æç¤º**
- **é€»è¾‘**: æ ¹æ®äº‹ä»¶åºåˆ—é…ç½®ï¼Œè‡ªåŠ¨å°†è¿ç»­çš„å­äº‹ä»¶æ ‡æ³¨ç‚¹ç»„åˆä¸ºäº‹ä»¶
- **å¯è§†åŒ–**: æ³¢å½¢å›¾ä¸Šæ˜¾ç¤ºåŠé€æ˜ç»¿è‰²è¾¹æ¡† (ä¸ä¿å­˜åˆ°æ•°æ®åº“)
- **ç¤ºä¾‹**:
  ```
  [Baselineç‚¹@2.1s] + [Approachç‚¹@2.5s] + [Impactç‚¹@3.0s] + [Ringdownç‚¹@3.8s]
  â†’ è‡ªåŠ¨ç”Ÿæˆäº‹ä»¶æç¤ºæ¡†: Event #1 [2.1s - 3.8s]
  ```

---

#### âš™ï¸ **Module 3: äº‹ä»¶åºåˆ—é…ç½®å™¨** (ä¼˜å…ˆçº§P1)

**3.2.7 å¯è§†åŒ–æ‹–æ‹½é…ç½®**
- **å…¥å£**: é¡¶éƒ¨å¯¼èˆªæ  "âš™ï¸ é…ç½®äº‹ä»¶åºåˆ—" æŒ‰é’®
- **å¼¹çª—å¸ƒå±€**:
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  äº‹ä»¶åºåˆ—é…ç½®å™¨                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  ğŸ“Œ æ¨¡æ¿é€‰æ‹©:                            â”‚
  â”‚  [å…¨å±€æ¨¡æ¿â–¼] [æˆ‘çš„æ¨¡æ¿â–¼] [+ æ–°å»ºæ¨¡æ¿]  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  é˜¶æ®µåº“ (æ‹–æ‹½æ·»åŠ ):                      â”‚
  â”‚  ğŸ”µ Baseline  ğŸŸ¢ Approach               â”‚
  â”‚  ğŸ”´ Impact    ğŸŸ£ Ringdown               â”‚
  â”‚  ğŸŸ¡ Custom... [+ æ–°å»ºé˜¶æ®µ]              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  å½“å‰åºåˆ—:                               â”‚
  â”‚  â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”        â”‚
  â”‚  â”‚ğŸ”µ â”‚ â†’ â”‚ğŸŸ¢ â”‚ â†’ â”‚ğŸ”´ â”‚ â†’ â”‚ğŸŸ£ â”‚        â”‚
  â”‚  â”‚ 1 â”‚   â”‚ 2 â”‚   â”‚ 3 â”‚   â”‚ 4 â”‚        â”‚
  â”‚  â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜        â”‚
  â”‚  (æ‹–åŠ¨è°ƒæ•´é¡ºåº | ç‚¹å‡»ç¼–è¾‘ | åˆ é™¤)       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  [å–æ¶ˆ]  [ä¿å­˜ä¸ºç§æœ‰æ¨¡æ¿]  [ä¿å­˜å¹¶åº”ç”¨] â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

**é˜¶æ®µå±æ€§ç¼–è¾‘**:
- åç§°: è‡ªå®šä¹‰æ–‡æœ¬ (å¦‚: "Baseline", "æ¥è§¦é˜¶æ®µ")
- é¢œè‰²: è‰²æ¿é€‰æ‹©å™¨ (16ç§é¢„è®¾é¢œè‰²)
- å¿«æ·é”®: è‡ªåŠ¨åˆ†é…æ•°å­—é”® 1-9 (å¯æ‰‹åŠ¨ä¿®æ”¹)

**æ¨¡æ¿ç®¡ç†**:
- **å…¨å±€æ¨¡æ¿**: ä»…ç®¡ç†å‘˜å¯åˆ›å»º/ç¼–è¾‘ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è§
- **ç§æœ‰æ¨¡æ¿**: ä¸ªäººåˆ›å»ºï¼Œä»…è‡ªå·±å¯è§
- **é»˜è®¤æ¨¡æ¿**: æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶è‡ªåŠ¨åº”ç”¨ç³»ç»Ÿé»˜è®¤æ¨¡æ¿

---

#### ğŸ“Š **Module 4: æ ‡æ³¨çŠ¶æ€ç»Ÿè®¡** (ä¼˜å…ˆçº§P2)

**3.2.8 è¿›åº¦ä»ªè¡¨ç›˜**
- **ä½ç½®**: æ–‡ä»¶åˆ—è¡¨ä¸Šæ–¹å¯æŠ˜å åŒºåŸŸ
- **å†…å®¹**:
  - æ€»ä½“è¿›åº¦ç¯å½¢å›¾ (å·²æ ‡æ³¨/æ€»æ•°)
  - å„æ–‡ä»¶æ ‡æ³¨è¿›åº¦å¯¹æ¯”æŸ±çŠ¶å›¾
  - æ ‡æ³¨çƒ­åŠ›å›¾ (æŒ‰æ—¥æœŸæ˜¾ç¤ºæ ‡æ³¨æ´»åŠ¨)
  - Topæ ‡æ³¨å‘˜æ’è¡Œæ¦œ

**3.2.9 æ ‡æ³¨ç»Ÿè®¡API**
```typescript
GET /api/stats/overview
Response: {
  totalFiles: 15,
  annotatedFiles: 9,
  totalEvents: 450,
  annotatedEvents: 270,
  progressByUser: [
    {userId: "xxx", username: "å¼ ä¸‰", eventCount: 120},
    ...
  ]
}
```

---

#### ğŸ‘¥ **Module 5: å¤šç”¨æˆ·åä½œ** (ä¼˜å…ˆçº§P3)

**3.2.10 æ‚²è§‚é”æœºåˆ¶**
- **åŠ é”æ—¶æœº**: ç”¨æˆ·ç‚¹å‡»TrialåŠ è½½æ³¢å½¢æ—¶
- **é”å®šé€»è¾‘**:
  ```python
  # FastAPIä¼ªä»£ç 
  @app.get("/api/files/{file_id}/trials/{trial_id}/waveform")
  async def get_waveform(file_id, trial_id, user_id):
      lock = await trial_locks.get(f"{file_id}:{trial_id}")
      if lock and lock.user_id != user_id:
          return {
              "status": "locked",
              "lockedBy": lock.username,
              "lockedAt": lock.timestamp,
              "message": f"è¯¥Trialæ­£åœ¨è¢« {lock.username} æ ‡æ³¨ä¸­"
          }
      await trial_locks.set(f"{file_id}:{trial_id}", {
          "user_id": user_id,
          "username": current_user.username,
          "timestamp": now()
      }, expire=1800)  # 30åˆ†é’Ÿè‡ªåŠ¨é‡Šæ”¾
      return waveform_data
  ```

- **è§£é”æ—¶æœº**:
  - ç”¨æˆ·ç‚¹å‡»å…¶ä»–Trial
  - ç”¨æˆ·ç™»å‡º
  - 30åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨é‡Šæ”¾

**3.2.11 é”å®šçŠ¶æ€å±•ç¤º**
- Trialåˆ—è¡¨ä¸­æ˜¾ç¤º ğŸ”’ å›¾æ ‡ + é”å®šè€…ç”¨æˆ·å
- é¼ æ ‡æ‚¬åœæ˜¾ç¤ºé”å®šæ—¶é—´å’Œå‰©ä½™æ—¶é•¿
- ç®¡ç†å‘˜å¯å¼ºåˆ¶è§£é” (éœ€ç¡®è®¤)

---

#### âœ… **Module 6: æ ‡æ³¨è´¨é‡æ£€æŸ¥** (ä¼˜å…ˆçº§P4)

**3.2.12 è‡ªåŠ¨æ£€æµ‹è§„åˆ™**
1. **é˜¶æ®µé¡ºåºå¼‚å¸¸**: æ£€æµ‹æ˜¯å¦ç¬¦åˆäº‹ä»¶åºåˆ—é…ç½®
2. **æ—¶é•¿å¼‚å¸¸**:
   - é˜¶æ®µæ—¶é•¿è¿‡çŸ­ (å¦‚Impact<50ms)
   - é˜¶æ®µæ—¶é•¿è¿‡é•¿ (å¦‚Baseline>10s)
3. **ç¼ºå¤±é˜¶æ®µ**: äº‹ä»¶ä¸­ç¼ºå°‘å¿…éœ€é˜¶æ®µ
4. **æ—¶é—´é‡å **: å¤šä¸ªäº‹ä»¶çš„æ—¶é—´èŒƒå›´é‡å 

**3.2.13 è´¨é‡æŠ¥å‘Š**
```typescript
GET /api/files/{file_id}/trials/{trial_id}/quality-check
Response: {
  status: "warning",
  issues: [
    {
      type: "duration_anomaly",
      severity: "medium",
      message: "Impacté˜¶æ®µæ—¶é•¿ä»…30ms (å»ºè®®>50ms)",
      location: {eventIndex: 2, phase: "Impact"}
    },
    ...
  ]
}
```

---

## 4. æ•°æ®æ¨¡å‹

### 4.1 MongoDB Collections

#### Collection: `users`
```typescript
{
  _id: ObjectId,
  username: string,           // å”¯ä¸€ç”¨æˆ·å
  email: string,
  passwordHash: string,       // bcryptåŠ å¯†
  role: "admin" | "annotator" | "viewer",
  preferences: {
    defaultTemplateId: ObjectId,  // é»˜è®¤äº‹ä»¶æ¨¡æ¿
    theme: "light" | "dark"
  },
  createdAt: Date,
  lastLogin: Date
}
```

#### Collection: `event_templates`
```typescript
{
  _id: ObjectId,
  name: string,               // "æ ‡å‡†æ¥è§¦å®éªŒ"
  isGlobal: boolean,          // å…¨å±€æ¨¡æ¿ vs ç§æœ‰æ¨¡æ¿
  createdBy: ObjectId,        // åˆ›å»ºè€…ç”¨æˆ·ID
  phases: [
    {
      id: string,             // "baseline"
      name: string,           // "Baseline"
      color: string,          // "#3B82F6"
      shortcut: string,       // "1"
      order: number           // 0, 1, 2...
    }
  ],
  createdAt: Date,
  updatedAt: Date
}
```

#### Collection: `event_annotations`
```typescript
{
  _id: ObjectId,
  fileId: string,             // "dataset/exp01/contact_01.h5"
  trialIndex: number,         // 0-based trialç´¢å¼•
  userId: ObjectId,           // æ ‡æ³¨è€…
  templateId: ObjectId,       // ä½¿ç”¨çš„äº‹ä»¶æ¨¡æ¿
  annotations: [
    {
      phaseId: string,        // å¼•ç”¨template.phases[].id
      timestamp: number,      // æ ‡æ³¨ç‚¹æ—¶é—´æˆ³(ç§’)
      confidence: number      // é¢„ç•™å­—æ®µ: æ ‡æ³¨ç½®ä¿¡åº¦ 0-1
    }
  ],
  status: "draft" | "completed" | "reviewed",
  createdAt: Date,
  updatedAt: Date,
  lockedBy: ObjectId | null,  // æ‚²è§‚é”å­—æ®µ
  lockedAt: Date | null
}
```

#### Collection: `trial_metadata` (ç¼“å­˜å±‚)
```typescript
{
  _id: ObjectId,
  fileId: string,
  trialIndex: number,
  thumbnailData: {            // ç¼©ç•¥å›¾æ•°æ® (100ä¸ªé‡‡æ ·ç‚¹)
    timestamps: number[],
    values: number[]
  },
  statistics: {
    duration: number,         // æ³¢å½¢æ—¶é•¿(ç§’)
    sampleRate: number,       // é‡‡æ ·ç‡
    dataPoints: number        // æ€»é‡‡æ ·ç‚¹æ•°
  },
  annotationProgress: number, // 0-100
  createdAt: Date
}
```

---

## 5. APIæ¥å£è®¾è®¡

### 5.1 è®¤è¯æ¥å£

```http
POST /api/auth/register
Request: {username, email, password}
Response: {userId, token}

POST /api/auth/login
Request: {username, password}
Response: {token, user: {id, username, role}}

POST /api/auth/logout
Headers: {Authorization: "Bearer {token}"}
Response: {success: true}
```

### 5.2 æ–‡ä»¶ç®¡ç†æ¥å£

```http
GET /api/files
Query: ?status=completed&search=exp01
Response: [
  {
    fileId: "dataset/exp01/contact_01.h5",
    trialCount: 25,
    progress: 60,
    annotatedEvents: 15,
    totalEvents: 25,
    status: "in_progress"
  }
]

GET /api/files/{file_id}/trials
Response: [
  {
    trialIndex: 0,
    thumbnail: {timestamps: [...], values: [...]},
    progress: 40,
    lockedBy: null
  }
]

GET /api/files/{file_id}/trials/{trial_id}/waveform
Response: {
  raw: {timestamps: [...], values: [...]},
  filtered: {timestamps: [...], values: [...]},
  annotations: [...],
  lock: {lockedBy: "å¼ ä¸‰", lockedAt: "2025-10-01T10:00:00Z"}
}
```

### 5.3 æ ‡æ³¨æ¥å£

```http
POST /api/annotations
Request: {
  fileId, trialIndex, templateId,
  annotation: {phaseId, timestamp}
}
Response: {annotationId, success: true}

DELETE /api/annotations/{annotation_id}
Response: {success: true}

PUT /api/annotations/{annotation_id}
Request: {timestamp: 3.14}
Response: {success: true}
```

### 5.4 æ¨¡æ¿æ¥å£

```http
GET /api/templates
Query: ?scope=global|private
Response: [
  {
    id, name, phases: [...], isGlobal, createdBy
  }
]

POST /api/templates
Request: {name, phases: [...], isGlobal: false}
Response: {templateId}

PUT /api/templates/{template_id}
Request: {name, phases: [...]}
Response: {success: true}
```

---

## 6. éåŠŸèƒ½éœ€æ±‚

### 6.1 æ€§èƒ½è¦æ±‚
- **é¦–å±åŠ è½½**: <2ç§’ (æ–‡ä»¶åˆ—è¡¨ + ç”¨æˆ·ä¿¡æ¯)
- **æ³¢å½¢æ¸²æŸ“**: 10ä¸‡é‡‡æ ·ç‚¹ <500ms
- **ç¼©æ”¾å“åº”**: <100ms (60fpsæµç•…ä½“éªŒ)
- **å¹¶å‘æ”¯æŒ**: 10ç”¨æˆ·åŒæ—¶æ ‡æ³¨

### 6.2 æµè§ˆå™¨å…¼å®¹æ€§
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### 6.3 å®‰å…¨è¦æ±‚
- JWT Tokenæœ‰æ•ˆæœŸ: 7å¤©
- å¯†ç å¼ºåº¦: æœ€å°‘8ä½ï¼ŒåŒ…å«æ•°å­—+å­—æ¯
- HTTPSå¼ºåˆ¶è·³è½¬
- CORSé…ç½®: ä»…å…è®¸ç‰¹å®šåŸŸåè®¿é—®

### 6.4 æ•°æ®å¤‡ä»½
- MongoDBè‡ªåŠ¨å¤‡ä»½: æ¯æ—¥å‡Œæ™¨3ç‚¹
- ä¿ç•™æœ€è¿‘30å¤©å¤‡ä»½
- æ ‡æ³¨æ•°æ®å¯¼å‡ºåŠŸèƒ½ (JSON/CSVæ ¼å¼)

---

## 7. UI/UXè®¾è®¡åŸåˆ™

### 7.1 è§†è§‰é£æ ¼
- **é…è‰²æ–¹æ¡ˆ**:
  - ä¸»è‰²: `#3B82F6` (è“è‰²)
  - æˆåŠŸ: `#10B981` (ç»¿è‰²)
  - è­¦å‘Š: `#F59E0B` (æ©™è‰²)
  - é”™è¯¯: `#EF4444` (çº¢è‰²)
- **å­—ä½“**:
  - æ ‡é¢˜: Inter, -apple-system
  - æ­£æ–‡: system-ui
  - ç­‰å®½: 'JetBrains Mono'
- **è®¾è®¡ç³»ç»Ÿ**: å‚è€ƒ Tailwind CSS + shadcn/ui

### 7.2 äº¤äº’åé¦ˆ
- **åŠ è½½çŠ¶æ€**: Skeletonå± (é¿å…ç©ºç™½é¡µ)
- **æ“ä½œåé¦ˆ**:
  - æˆåŠŸ: ç»¿è‰²Toast + âœ… å›¾æ ‡
  - é”™è¯¯: çº¢è‰²Toast + âŒ å›¾æ ‡
  - å¤„ç†ä¸­: è½¬åœˆåŠ è½½åŠ¨ç”»
- **å¿«æ·é”®æç¤º**: æ‚¬æµ®å·¥å…·æç¤º (Tooltip)

### 7.3 å“åº”å¼é€‚é…
- **æ¡Œé¢ç«¯**: 1920x1080 æœ€ä½³ä½“éªŒ
- **ç¬”è®°æœ¬**: 1366x768 æœ€å°æ”¯æŒ
- **ç§»åŠ¨ç«¯**: æš‚ä¸æ”¯æŒ (Phase 2è€ƒè™‘)

---

## 8. é‡Œç¨‹ç¢‘ä¸éªŒæ”¶æ ‡å‡†

### Phase 1: åŸºç¡€æ³¢å½¢æµè§ˆ (2å‘¨)
**åŠŸèƒ½èŒƒå›´**:
- æ–‡ä»¶/Trialåˆ—è¡¨å±•ç¤º
- æ³¢å½¢å›¾æ¸²æŸ“ (uPloté›†æˆ)
- ç¼©æ”¾äº¤äº’ (æ»šè½® + Shift/Cmd)
- ç¼©ç•¥å›¾ç”Ÿæˆ

**éªŒæ”¶æ ‡å‡†**:
- âœ… å¯åŠ è½½datasetç›®å½•ä¸‹æ‰€æœ‰H5æ–‡ä»¶
- âœ… æ³¢å½¢æ¸²æŸ“10ä¸‡ç‚¹ <500ms
- âœ… ç¼©æ”¾æ“ä½œæµç•…æ— å¡é¡¿

---

### Phase 2: äº‹ä»¶åºåˆ—é…ç½®å™¨ (1å‘¨)
**åŠŸèƒ½èŒƒå›´**:
- æ‹–æ‹½å¼é…ç½®ç•Œé¢
- æ¨¡æ¿ç®¡ç† (å…¨å±€/ç§æœ‰)
- å¿«æ·é”®ç»‘å®š

**éªŒæ”¶æ ‡å‡†**:
- âœ… å¯åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶åºåˆ—
- âœ… å¿«æ·é”®1-9åˆ‡æ¢é˜¶æ®µæ¨¡å¼
- âœ… æ¨¡æ¿ä¿å­˜åˆ°MongoDB

---

### Phase 3: æ ‡æ³¨çŠ¶æ€ç»Ÿè®¡ (1å‘¨)
**åŠŸèƒ½èŒƒå›´**:
- è¿›åº¦ä»ªè¡¨ç›˜
- ç»Ÿè®¡å›¾è¡¨ (ECharts)
- æ ‡æ³¨æ•°æ®ä¿å­˜

**éªŒæ”¶æ ‡å‡†**:
- âœ… å®æ—¶æ˜¾ç¤ºæ ‡æ³¨è¿›åº¦
- âœ… ç‚¹å‡»æ ‡æ³¨åç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
- âœ… å½©è‰²Maskæ­£ç¡®æ˜¾ç¤ºå·²æ ‡æ³¨åŒºåŸŸ

---

### Phase 4: å¤šç”¨æˆ·åä½œ (1.5å‘¨)
**åŠŸèƒ½èŒƒå›´**:
- ç”¨æˆ·è®¤è¯ (JWT)
- æ‚²è§‚é”æœºåˆ¶
- é”å®šçŠ¶æ€å±•ç¤º

**éªŒæ”¶æ ‡å‡†**:
- âœ… ç”¨æˆ·Aæ ‡æ³¨Trialæ—¶ï¼Œç”¨æˆ·Bçœ‹åˆ°ğŸ”’æç¤º
- âœ… 30åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨è§£é”
- âœ… ç®¡ç†å‘˜å¯å¼ºåˆ¶è§£é”

---

### Phase 5: è´¨é‡æ£€æŸ¥ (1å‘¨)
**åŠŸèƒ½èŒƒå›´**:
- è‡ªåŠ¨è´¨é‡æ£€æµ‹è§„åˆ™
- è´¨é‡æŠ¥å‘Šç”Ÿæˆ
- å¼‚å¸¸æ ‡æ³¨é«˜äº®æç¤º

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ£€æµ‹å‡ºæ—¶é•¿å¼‚å¸¸ã€é¡ºåºé”™è¯¯ç­‰é—®é¢˜
- âœ… è´¨é‡æŠ¥å‘Šä»¥å¼¹çª—å½¢å¼å±•ç¤º
- âœ… æ ‡æ³¨å‘˜å¯é€‰æ‹©å¿½ç•¥æˆ–ä¿®å¤é—®é¢˜

---

## 9. é£é™©ä¸ä¾èµ–

### 9.1 æŠ€æœ¯é£é™©
- **H5æ–‡ä»¶è§£ææ€§èƒ½**: å•ä¸ªæ–‡ä»¶>1GBæ—¶å¯èƒ½åŠ è½½ç¼“æ…¢
  - ç¼“è§£: ä½¿ç”¨h5pyåˆ†å—è¯»å– + Redisç¼“å­˜
- **å‰ç«¯å†…å­˜å ç”¨**: åŒæ—¶åŠ è½½å¤šä¸ªTrialå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
  - ç¼“è§£: æ‡’åŠ è½½ + å¸è½½ä¸å¯è§Trialæ•°æ®

### 9.2 ä¾èµ–é¡¹
- **Pythonåº“**: h5py, numpy, scipy (é¢„å¤„ç†)
- **å‰ç«¯åº“**: React 18, uPlot, TailwindCSS
- **åç«¯æ¡†æ¶**: FastAPI, Motor (å¼‚æ­¥MongoDB)
- **åŸºç¡€è®¾æ–½**: MongoDB 5.0+, Redis (å¯é€‰)

---

## 10. åç»­è¿­ä»£è®¡åˆ’ (Phase 6+)

- **AIè¾…åŠ©æ ‡æ³¨**: åŸºäºå·²æ ‡æ³¨æ•°æ®è®­ç»ƒæ¨¡å‹ï¼Œè‡ªåŠ¨é¢„æ ‡æ³¨
- **å®æ—¶åä½œ**: WebSocketåŒæ­¥æ˜¾ç¤ºå…¶ä»–ç”¨æˆ·å…‰æ ‡å’Œæ“ä½œ
- **æ ‡æ³¨å†å²ç‰ˆæœ¬**: æ”¯æŒå›æ»šåˆ°ä»»æ„å†å²çŠ¶æ€
- **ç§»åŠ¨ç«¯é€‚é…**: PWAæ¸è¿›å¼Webåº”ç”¨
- **æ‰¹é‡å¯¼å‡º**: æ ‡æ³¨ç»“æœå¯¼å‡ºä¸ºMATLAB/Pythonå¯è¯»æ ¼å¼
- **è´¨é‡è¯„åˆ†ç³»ç»Ÿ**: æ ¹æ®æ ‡æ³¨ä¸€è‡´æ€§è¯„ä¼°æ ‡æ³¨å‘˜æ°´å¹³

---

## é™„å½•A: æœ¯è¯­è¡¨

| æœ¯è¯­ | å®šä¹‰ |
|------|------|
| **Trial** | H5æ–‡ä»¶ä¸­çš„å•æ¬¡å®éªŒè®°å½• |
| **Event** | ä¸€ä¸ªå®Œæ•´çš„å®éªŒäº‹ä»¶ï¼Œç”±å¤šä¸ªå­é˜¶æ®µç»„æˆ |
| **Phase** | äº‹ä»¶çš„å­é˜¶æ®µ (å¦‚Baseline, Impact) |
| **Template** | äº‹ä»¶åºåˆ—é…ç½®æ¨¡æ¿ |
| **Mask** | æ³¢å½¢å›¾ä¸Šçš„å½©è‰²åŠé€æ˜è¦†ç›–å±‚ |

---

## é™„å½•B: å‚è€ƒèµ„æ–™

- [uPlotæ–‡æ¡£](https://github.com/leeoniya/uPlot)
- [FastAPIæ–‡æ¡£](https://fastapi.tiangolo.com/)
- [MongoDB Motoræ–‡æ¡£](https://motor.readthedocs.io/)
- [shadcn/uiç»„ä»¶åº“](https://ui.shadcn.com/)
- [HDF5æ–‡ä»¶æ ¼å¼è§„èŒƒ](https://www.hdfgroup.org/)

---

**æ–‡æ¡£ç»´æŠ¤**: è¯·åœ¨éœ€æ±‚å˜æ›´æ—¶åŠæ—¶æ›´æ–°æœ¬æ–‡æ¡£ï¼Œç¡®ä¿å¼€å‘å›¢é˜Ÿä¿¡æ¯åŒæ­¥ã€‚
